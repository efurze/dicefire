/*! dicefire 16-02-2016 */
var AI=AI||{};if(AI.Aggressive=function(a){},AI.Aggressive.create=function(a,b){return new AI.Aggressive(a)},AI.Aggressive.getName=function(){return"Aggressive"},AI.Aggressive.prototype.startTurn=function(a,b){b=b||0;for(var c=this,d=a.getState(),e=d.currentPlayerId(),f=d.countryIds(),g=0;g<f.length;g++){var h=f[g];if(d.countryOwner(h)==e){var i=[];if(a.adjacentCountries(h).forEach(function(a){d.countryOwner(a)!=e&&d.countryDice(h)>1&&d.countryDice(h)>=d.countryDice(a)&&i.push(a)}),i.length>0){var j=i[Math.floor(Math.random()*i.length)];return void a.attack(h,j,function(d){c.startTurn(a,b+1)})}}}a.endTurn()},"undefined"!=typeof module&&module.exports&&(module.exports=AI.Aggressive),"undefined"!=typeof module&&module.exports)var Globals=require("../globals.js"),window={};var AI=AI||{};AI.DoNothing=function(a){},AI.DoNothing.create=function(a,b){return new AI.DoNothing(a)},AI.DoNothing.getName=function(){return"DoNothing"},AI.DoNothing.prototype.startTurn=function(a){a.endTurn()},"undefined"!=typeof module&&module.exports&&(module.exports=AI.DoNothing);var AI=AI||{};if(AI.Greedy=function(){},AI.Greedy.getName=function(){return"Greedy 1.0"},AI.Greedy.create=function(a,b){return new AI.Plyer(a,1)},"undefined"!=typeof module&&module.exports&&(module.exports=AI.Greedy),"undefined"!=typeof module&&module.exports)var Globals=require("../globals.js"),window={};var AI=AI||{};AI.Human=function(a){},AI.Human.create=function(a,b){return new AI.Human(a)},AI.Human.getName=function(){return"human"},AI.Human.prototype.startTurn=function(a){},"undefined"!=typeof module&&module.exports&&(module.exports=AI.Human);var AI=AI||{};AI.Passive=function(a){},AI.Passive.getName=function(){return"Passive"},AI.Passive.create=function(a,b){return new AI.Passive(a)},AI.Passive.prototype.startTurn=function(a,b){b=b||0;for(var c=this,d=a.getState(),e=d.currentPlayerId(),f=d.countryIds(),g=0;g<f.length;g++){var h=f[g];if(d.countryOwner(h)==e){var i=[];if(a.adjacentCountries(h).forEach(function(a){d.countryOwner(a)!=e&&d.countryDice(h)>1&&d.countryDice(h)>d.countryDice(a)&&i.push(a)}),i.length>0){var j=i[Math.floor(Math.random()*i.length)];return void a.attack(h,j,function(d){c.startTurn(a,b+1)})}}}a.endTurn()};var AI=AI||{};if(AI.Plyer=function(a,b,c){this._myId=a,this._MAX_PLIES=b||1,this._lookahead=c||1,this._interface=null},AI.Plyer.getName=function(){return"Plyer 1.0"},AI.Plyer.create=function(a,b){return new AI.Plyer(a,2,1)},AI.Plyer.prototype.startTurn=function(a){Globals.debug("**STARTING TURN**",Globals.LEVEL.INFO,Globals.CHANNEL.PLYER);var b=this;b._interface=a;var c=a.getState();Globals.ASSERT(b._myId==c.currentPlayerId()),Globals.debug("I AM PLAYER "+b._myId,Globals.LEVEL.INFO,Globals.CHANNEL.PLYER),Globals.debug("Gamestate: ",JSON.stringify(c),Globals.LEVEL.DEBUG,Globals.CHANNEL.PLYER),b.logEval(c);var d=b.bestMove(c,b._MAX_PLIES);Globals.debug("Attempting following move: ",JSON.stringify(d),Globals.LEVEL.INFO,Globals.CHANNEL.PLYER),b.makeMoves(d)},AI.Plyer.prototype.logEval=function(a){var b=this,c=a.playerIds().map(function(c){return b.evalPlayer(a,c)});Globals.debug("Player Scores: ",JSON.stringify(c),Globals.LEVEL.INFO,Globals.CHANNEL.PLYER)},AI.Plyer.prototype.makeMoves=function(a){for(var b=this,c=b._interface.getState(),d=new Attack;a&&a.hasMoreAttacks()&&d.isEmpty();)d=a.pop(),c.countryOwner(d.from())!=b._myId&&(Globals.debug("Country "+d.from()+" doesn't belong to us, skipping move "+d.toString(),Globals.LEVEL.DEBUG,Globals.CHANNEL.PLYER),d.clear());return!a||!a.hasMoreAttacks()&&d.isEmpty()?void b.finishTurn():void(d.isEmpty()||(Globals.debug("Country "+d.from()+" ATTACKING country "+d.to(),Globals.LEVEL.DEBUG,Globals.CHANNEL.PLYER),b._interface.attack(d.from(),d.to(),function(c){c?Globals.debug("ATTACK SUCCEEDED",Globals.LEVEL.DEBUG,Globals.CHANNEL.PLYER):Globals.debug("ATTACK FAILED",Globals.LEVEL.DEBUG,Globals.CHANNEL.PLYER),b.makeMoves(a)})))},AI.Plyer.prototype.finishTurn=function(){var a=this,b=a._interface.getState();Object.keys(b.playerIds()).forEach(function(a){Globals.debug("Countries for player "+a+": "+Object.keys(b.playerCountries(a)).join(),Globals.LEVEL.INFO,Globals.CHANNEL.PLYER)}),Globals.debug("**ENDING TURN**",Globals.LEVEL.INFO,Globals.CHANNEL.PLYER),a.logEval(b),a._interface.endTurn()},AI.Plyer.prototype.bestMove=function(a,b){var c=this,d=c.findAllGreedyMoves(a,10);if(Globals.debug("Found "+d.length+" moves",Globals.LEVEL.INFO,Globals.CHANNEL.PLYER),Globals.debug(d,Globals.LEVEL.INFO,Globals.CHANNEL.PLYER),1>=b)return c.pickBest(d,a);var e=d.map(function(d){for(var e=[],f=c.applyMove(d,a);(f=c.doEndOfTurn(f)).currentPlayerId()!=a.currentPlayerId();){var g=c.bestMove(f,b-1);e.push(g),f=c.applyMove(g,f)}return f}),f=Globals.indexOfMax(e.map(function(a){return c.evalPosition(a,c.evalPlayer.bind(c))}));return d[f]},AI.Plyer.prototype.findBestGreedyMove=function(a,b){var c=this,d=c.findAllGreedyMoves(a,b);return Globals.ASSERT(d.length),c.pickBest(d,a)},AI.Plyer.prototype.pickBest=function(a,b){var c=this;if(!a.length)return new Move;var d=a.map(function(a){return c.evalMove(a,b,c.evalPlayer.bind(c))}),e=Globals.indexOfMax(d);return a[e]},AI.Plyer.prototype.findAllGreedyMoves=function(a,b){b=b||1;var c=this,d=a.currentPlayerId()==c._myId?c._lookahead:1,e=[],f=c.findAllMoves(a,d);if(!f||!f.length)return e.push(new Move),e;var g=Globals.indexOfMax(f.map(function(b){return c.evalMove(b,a,c.evalPlayer.bind(c))}));return e.push(f[g]),b>1&&c.findAllGreedyMoves(c.applyMove(f[g],a,!0),b-d).forEach(function(a){var b=new Move;b.push(f[g]),b.push(a),e.push(b)}),Globals.ASSERT(e.length),e},AI.Plyer.prototype.doEndOfTurn=function(a){Globals.ASSERT(a&&a instanceof Gamestate);var a=a.clone();Object.keys(a.playerCountries(a.currentPlayerId())).forEach(function(b){b=Number(b);var c=a.countryDice(b)+1;a.setCountryDice(b,Math.min(c,8))});var b=a.currentPlayerId();do b++,b%=Object.keys(a.playerIds()).length;while(a.playerHasLost(b));return a.setCurrentPlayerId(b),a},AI.Plyer.prototype.findAllMoves=function(a,b){b=b||1;var c=this,d=[],e=c.findAllAttacks(a);return e.forEach(function(e){d.push(new Move(e)),b>1&&c.findAllMoves(c.applyAttack(e,a,!0),b-1).forEach(function(a){var b=new Move(e);b.push(a),d.push(b)})}),d},AI.Plyer.prototype.findAllAttacks=function(a,b){Globals.ASSERT(a);var b=b||.44,c=[],d=this;return Object.keys(a.playerCountries(a.currentPlayerId())).forEach(function(e){var f=Number(e);if(Globals.ASSERT(a.countryOwner(f)==a.currentPlayerId()),!(a.countryDice(f)<2)){var g=d._interface.adjacentCountries(f),h=g?g.filter(function(b){return a.countryOwner(b)!=a.currentPlayerId()}):[];Globals.debug("country "+f+" adjacent to: "+JSON.stringify(h),Globals.LEVEL.TRACE,Globals.CHANNEL.PLYER),h.forEach(function(d){Globals.ASSERT(a.countryOwner(d)!=a.currentPlayerId());var e=new Attack(f,d);AI.Util.attackOdds(a,e)>=b?(Globals.debug("possible attack found",e.toString(),Globals.LEVEL.TRACE,Globals.CHANNEL.PLYER),c.push(e)):Globals.debug("attack too improbable",e.toString(),Globals.LEVEL.TRACE,Globals.CHANNEL.PLYER)})}}),Globals.debug("returning attacks ",Attack.arrayString(c),Globals.LEVEL.TRACE,Globals.CHANNEL.PLYER),c},AI.Plyer.prototype.applyMove=function(a,b){if(Globals.ASSERT(a instanceof Move||a instanceof Attack),Globals.ASSERT(b&&b instanceof Gamestate),a instanceof Attack)return this.applyAttack(a,b,!0);if(!a.hasMoreAttacks())return b;for(var c=b.clone(),d=0;d<a.length();d++)c=this.applyAttack(a.at(d),c,!0);var e=b.currentPlayerId;return Globals.ASSERT(this.totalDice(e,b)==this.totalDice(e,c)),c},AI.Plyer.prototype.applyAttack=function(a,b,c){Globals.ASSERT(b&&b instanceof Gamestate),Globals.ASSERT(a instanceof Attack);var b=b.clone();if(a.isEmpty())return b;var d=this,e=b.countryOwner(a.from()),f=b.countryOwner(a.to());return Globals.ASSERT(e!=f),Globals.ASSERT(e==b.currentPlayerId()),c&&(b.setCountryDice(a.to(),b.countryDice(a.from())-1),b.setCountryOwner(a.to(),e),b.setNumContiguous(f,d.maxIslandSize(f,b)),b.setNumContiguous(e,d.maxIslandSize(e,b))),b.setCountryDice(a.from(),1),b},AI.Plyer.prototype.maxIslandSize=function(a,b){Globals.ASSERT(b&&b instanceof Gamestate);var c={},d=0,e=this,f=function(d){return c[d]?0:(c[d]=!0,1+e._interface.adjacentCountries(d).reduce(function(c,d){return b.countryOwner(d)==a&&(c+=f(d)),c},0))},g=b.playerCountries(a);return Object.keys(g).forEach(function(a){a=Number(a);var b=f(a);b>d&&(d=b)}),d},AI.Plyer.prototype.totalDice=function(a,b){Globals.ASSERT(b&&b instanceof Gamestate);var c=0,d=b.countryIds();return d.forEach(function(d){b.countryOwner(d)==a&&(c+=b.countryDice(d))}),c},AI.Plyer.prototype.totalCountries=function(a,b){Globals.ASSERT(b&&b instanceof Gamestate);var c=0,d=b.countryIds();return d.forEach(function(d){b.countryOwner(d)==a&&c++}),c},AI.Plyer.prototype.evalMove=function(a,b,c){Globals.ASSERT(a instanceof Move),Globals.debug("evalMove: ",a.toString(),Globals.LEVEL.TRACE,Globals.CHANNEL.PLYER);var d=this,e=0;if(a.hasMoreAttacks()){a=a.clone();var f=a.pop(),g=d.applyAttack(f,b,!0),h=d.applyAttack(f,b,!1),i=AI.Util.attackOdds(b,f);e=(1-i)*d.evalPosition(h,c)+i*d.evalMove(a,g,c)}else e=d.evalPosition(b,c);return e},AI.Plyer.prototype.evalPosition=function(a,b){Globals.ASSERT(a);var c=[];c.length=Object.keys(a.playerIds()).length,Object.keys(a.playerIds()).forEach(function(d){c[d]=b(a,d)});for(var d=(c[a.currentPlayerId()],0),e=0;e<c.length;e++)e!=a.currentPlayerId()&&(d+=Math.pow(c[e],2));return d=Math.sqrt(d),c[a.currentPlayerId()]-d},AI.Plyer.prototype.evalPlayer=function(a,b){Globals.ASSERT(a&&a instanceof Gamestate);var c=this;if(a.playerHasLost(b))return 0;Globals.ASSERT(c instanceof AI.Plyer);var d=c.totalCountries(b,a),e=a.numContiguous(b),f=c.totalDice(b,a);return f+=a.currentPlayerId()==b?Math.min(a.storedDice(b)+e,64):a.storedDice(b),2*e-d+f},"undefined"!=typeof module&&module.exports&&(module.exports=AI.Plyer),"undefined"!=typeof module&&module.exports)var Globals=require("../globals.js"),Gamestate=require("../game/gamestate.js"),window={};var AI=AI||{};AI.Util={ODDS_ARRAY:[[.4098,.0603,.0047,0,0,0,0,0],[.8643,.4368,.1184,.0182,.0024,2e-4,0,0],[.9874,.8094,.4479,.1604,.0345,.007,5e-4,4e-4],[.9995,.9612,.7708,.4578,.1941,.0575,.0128,.0024],[1,.9944,.9395,.7359,.4591,.2107,.0714,.0212],[1,.9997,.9877,.9129,.7275,.4626,.233,.0923],[1,1,.9987,.9772,.8913,.7131,.4652,.2514],[1,1,.9998,.9967,.9681,.8787,.6909,.466]],attackOdds:function(a,b){if(Globals.ASSERT(a&&a instanceof Gamestate),b.isEmpty())return 1;Globals.ASSERT(b instanceof Attack);var c=a.countryDice(b.from()),d=a.countryDice(b.to());if(c>0&&d>0){var e=AI.Util.ODDS_ARRAY[c-1][d-1];return e}return 0}};var Attack=function(a,b){"undefined"!=typeof a&&"undefined"!=typeof b?(this._from=a,this._to=b):(this._from=-1,this._to=-1)};Attack.prototype.clone=function(){return new Attack(this._from,this._to)},Attack.prototype.clear=function(){this._from=-1,this._to=-1},Attack.prototype.from=function(){return this._from},Attack.prototype.to=function(){return this._to},Attack.prototype.isEmpty=function(){return this._from<0||this._to<0},Attack.prototype.toString=function(){return this.isEmpty()?"()":"("+this._from+","+this._to+")"},Attack.arrayString=function(a){var b="[";if(Array.isArray(a)){if(!a.length)return"[]";Globals.ASSERT(a[0]instanceof Attack||a[0]instanceof Move);for(var c=0;c<a.length;c++)a[c]?b+=a[c].toString():Globals.ASSERT(!1)}return b+="]"};var Move=function(a){this._attacks=[],"undefined"!=typeof a&&this._attacks.push(a)};Move.prototype.clone=function(){for(var a=new Move,b=0;b<this._attacks.length;b++)a.push(this._attacks[b].clone());return a},Move.prototype.length=function(){return this._attacks.length},Move.prototype.push=function(a){Globals.ASSERT(Array.isArray(a)||a instanceof Attack||a instanceof Move),Array.isArray(a)?this._attacks.push(new Attack(a[0],a[1])):a instanceof Attack?this._attacks.push(a):a instanceof Move&&a.hasMoreAttacks()&&(this._attacks=this._attacks.concat(a._attacks)),this._attacks.forEach(function(a){Globals.ASSERT(a)})},Move.prototype.pop=function(){return this._attacks.shift()||new Attack},Move.prototype.at=function(a){return Globals.ASSERT(a>=0&&a<this._attacks.length),this._attacks[a]},Move.prototype.isEmpty=function(){return!this._attacks.length||this._attacks[0].isEmpty()},Move.prototype.hasMoreAttacks=function(){return!this.isEmpty()},Move.prototype.toString=function(){for(var a="[",b=0;b<this._attacks.length;b++)a+=this._attacks[b].toString();return a+="]"},"undefined"!=typeof module&&module.exports&&(AI.Util.Move=Move,AI.Util.Attack=Attack,module.exports=AI.Util),$(function(){var a=[AI.Plyer,AI.Greedy,AI.Aggressive],b={};a.forEach(function(a){b[a.getName()]=a}),window.onerror=function(a,b,c){Globals.debug("Uncaught exception",a,b,c,Globals.LEVEL.ERROR,Globals.CHANNEL.CLIENT,Client._gameId)},window.Client={_canvas:document.getElementById("c"),_socket:null,_downloader:null,_history:null,_gameId:null,_initialized:!1,_watch:!1,_map:null,_gameInfo:null,_players:{},_playerStatus:{},_rendererInitialized:!1,_currentViewState:-1,_rendering:!1,_historyController:null,_playerId:-1,_isMyTurn:!1,_mapController:null,init:function(a,b){Client._gameId=a,Client._watch=b,Globals.debug("gameId:",a,Globals.LEVEL.INFO,Globals.CHANNEL.CLIENT);var c=new Uploader;Globals.initLogger(a,c.uploadLogDump.bind(c)),Client._history=new History(a),Client._historyController=new HistoryController(Client._history,a),Client._downloader=new Downloader,Client._downloader.getGameInfo(a,Client.gameInfoCB);var d="";b?(Globals.debug("Connecting as watcher",Globals.LEVEL.INFO,Globals.CHANNEL.CLIENT),d=window.location.hostname+":5001/watch/"+a):d=window.location.hostname+":5001/"+a,Client._socket=new SocketWrapper(io.connect(d),a),Client._socket.on("error",Client.socket_error),Client._socket.on("disconnect",Client.disconnect),Client._socket.on("connect",Client.connect),Client._socket.on(Message.TYPE.STATE,Client.state),Client._socket.on(Message.TYPE.PLAYER_STATUS,Client.player_status),b||(Client._socket.on(Message.TYPE.CREATE_BOT,Client.create_bot),Client._socket.on(Message.TYPE.CREATE_HUMAN,Client.create_human),Client._socket.on(Message.TYPE.START_TURN,Client.start_turn))},setInitialized:function(){Client._rendererInitialized||(Globals.debug("Initializing renderer",Globals.LEVEL.INFO,Globals.CHANNEL.CLIENT),Client._watch||Globals.ASSERT(Client._mapController),$("#game").css("display","block"),Client._rendererInitialized=!0,Renderer.init(Client._canvas,Client._map,Client._gameInfo.getPlayers(),Client),Object.keys(Client._playerStatus).forEach(function(a){Client._playerStatus[a]||Renderer.setPlayerName(a,"Disconnected")}),Client.processNextState()),Client._initialized||Client._watch||(Client._initialized=!0,Client._socket.sendPlayerInitialized(Client._playerId))},upToDate:function(){return Client._currentViewState==Client._history.latestId()},processNextState:function(){if(Client._rendererInitialized&&!Client._rendering&&!Client._historyController.viewingHistory()&&!Client.upToDate()){var a=0;a=Client._currentViewState<0?Client._history.latestId():Client._currentViewState+1,Client._history.getState(a,function(a){Client._map&&Client._map.setState(a),Client.render(a)})}},render:function(a){Client._rendererInitialized&&a&&!Client._historyController.viewingHistory()&&(Client._rendering||(Client._rendering=!0,Globals.debug("render state",a.stateId(),Globals.LEVEL.TRACE,Globals.CHANNEL.CLIENT),Renderer.stateUpdate(a,a.stateId())))},stateRendered:function(a,b){Globals.debug("state",b,"rendered",Globals.LEVEL.TRACE,Globals.CHANNEL.CLIENT),Client._rendering=!1,Client._currentViewState=a.stateId(),Client._historyController.viewingHistory()||(Client._historyController.setViewState(Client._currentViewState),Client.upToDate()||Client.processNextState())},mouseOverCountry:function(a){Client._mapController&&Client._mapController.mouseOverCountry(a)},endTurnClicked:function(){Globals.debug("End Turn clicked",Globals.LEVEL.INFO,Globals.CHANNEL.CLIENT),Client._isMyTurn&&Client.upToDate()?(Client._isMyTurn=!1,Client._socket.sendEndTurn(Client._playerId)):Client._isMyTurn?Client.upToDate()||Globals.debug("End Turn clicked when client isn't up to date",Globals.LEVEL.WARN,Globals.CHANNEL.CLIENT):Globals.debug("End Turn clicked when it's not my turn",Globals.LEVEL.WARN,Globals.CHANNEL.CLIENT)},MapControllerInterface:{currentPlayerId:function(){return Client._history.getState(Client._currentViewState).currentPlayerId()},attack:function(a,b,c){Client._isMyTurn&&Client._socket.sendAttack(a.id(),b.id(),Client._playerId)},clickable:function(){return Client._rendering||!Client._isMyTurn||Client._historyController.viewingHistory()?!1:!0}},socket_error:function(a,b){Globals.debug("=> Socket ERROR:",b,Globals.LEVEL.WARN,Globals.CHANNEL.CLIENT_SOCKET)},disconnect:function(a){Globals.debug("=> Socket DISCONNECT",Globals.LEVEL.INFO,Globals.CHANNEL.CLIENT_SOCKET),Object.keys(Client._players).forEach(function(a){Client._players[a]&&Client._players[a].turnEnded()}),Client._isMyTurn=!1},connect:function(a){Globals.debug("=> Socket CONNECT",Globals.LEVEL.INFO,Globals.CHANNEL.CLIENT_SOCKET),Client._initialized&&!Client._watch&&Client._socket.sendPlayerInitialized(Client._playerId)},player_status:function(a,b){Client._playerStatus[b.playerId]=b.connected,b.connected?Renderer.setPlayerName(b.playerId,b.playerName):Renderer.setPlayerName(b.playerId,"Disconnected")},state:function(a,b){Client._historyController.updateStateCount(b.stateId),Client._history.getState(b.stateId,function(a){Client.processNextState()})},create_bot:function(a,c){var d=c.name;if(b.hasOwnProperty(d)){var e=parseInt(c.playerId);if(Globals.debug("Initializing new bot",d,"with playerId:",e,Globals.LEVEL.INFO,Globals.CHANNEL.CLIENT),Client._players.hasOwnProperty(e)){if(Globals.debug("Already have a player",e,Globals.LEVEL.INFO,Globals.CHANNEL.CLIENT),Client._players[e].getName()==d)return Globals.debug("Same AI, not re-initializing",Globals.LEVEL.INFO,Globals.CHANNEL.CLIENT),void Client._players[e].turnEnded();Globals.debug("Different AI",Client._players[e].getName(),"re-initializing player",e,Globals.LEVEL.INFO,Globals.CHANNEL.CLIENT),Client._players[e].stop(),Client._players[e]=null}Client._players[e]=new SocketAIController(Client._socket,Client._history,b[d],e),Client._map&&Client._players[e].start()}else Globals.debug("Unknown AI requested:",d,Globals.LEVEL.ERROR,Globals.CHANNEL.CLIENT)},create_human:function(a,b){Client._playerId!=b.playerId&&(Client._playerId=b.playerId,Client._players[b.playerId]=Engine.PlayerInterface,Client._mapController&&Client._mapController.setPlayerId(Client._playerId),$("#end_turn").click(Client.endTurnClicked),$("#game_controls").css("display","block"))},start_turn:function(a,b){b.playerId==Client._playerId&&Client._history.getState(b.stateId,function(a){Client._isMyTurn=!0})},mapDataCB:function(a,b){a?Client._map?Globals.debug("Got map when we already had one",Globals.LEVEL.DEBUG,Globals.CHANNEL.CLIENT):(Globals.debug("Got map from server",Globals.LEVEL.INFO,Globals.CHANNEL.CLIENT),Client._map=new Map,Client._map.deserializeHexes(b),Object.keys(Client._players).forEach(function(a){Globals.ASSERT(Client._players[a]),Client._players[a].start()}),Client._watch||Client._mapController||(Client._mapController=new Mapcontroller(Client._playerId,Client._map,Client.MapControllerInterface)),Client.setInitialized()):Globals.debug("Get Map error",b,Globals.LEVEL.ERROR,Globals.CHANNEL.CLIENT)},gameInfoCB:function(a,b){a?(Client._gameInfo||(Globals.debug("Got gameInfo from server",Globals.LEVEL.INFO,Globals.CHANNEL.CLIENT),Client._gameInfo=Gameinfo.deserialize(b)),Client._map||Client._downloader.getMap(Client._gameId,Client.mapDataCB)):Globals.debug("Get gameInfo error",b,Globals.LEVEL.ERROR,Globals.CHANNEL.CLIENT)}}}),$(function(){window.onerror=function(a,b,c){Globals.debug("Uncaught exception",a,b,c,Globals.LEVEL.ERROR,Globals.CHANNEL.CLIENT,Game._gameId)},window.Game={_canvas:document.getElementById("c"),_controller:null,_mapController:null,_gameId:null,_currentState:null,_uploader:null,_engine:null,_aiHash:null,_aiIdx:-1,init:function(gameId,players,aiHash,test){Game._gameId=gameId,Game._aiHash=aiHash,Game._test=test,Game._uploader=new Uploader,Globals.initLogger(gameId,Game._uploader.uploadLogDump.bind(Game._uploader)),"string"==typeof players&&(players=players.trim().split(","));var aiClassName="ai"+aiHash;Game.start(players.map(function(name,idx){return name=name.trim(),name===AI.Human.getName()?AI.Human:name===AI.Plyer.getName()?AI.Plyer:name===AI.Greedy.getName()?AI.Greedy:name===AI.Aggressive.getName()?AI.Aggressive:name===aiHash?(Game._aiIdx=idx,eval(aiClassName)):void 0}))},start:function(a){console.log("playerCode",a),$("#game").css("display","block"),$("#game_controls").css("display","block"),Game._engine=new Engine;var b=[],c=[];a.forEach(function(a,c){"human"==a.getName()?b.push(Engine.PlayerInterface):c==Game._aiIdx?b.push(new AIWrapper(Game._aiHash,Game._engine,b.length,Game._test,a.getName())):b.push(new AIWrapper(a,Game._engine,b.length,!1))}),Game._engine.init(b),Game._engine.registerGameCallback(Game.gameOver),Game._engine.registerStateCallback(Renderer.stateUpdate.bind(Renderer)),a.forEach(function(a){c.push(a.getName())}),Game._controller=new Gamecontroller(0,Game._engine),Game._mapController=new Mapcontroller(0,Game._engine.map(),Game.mapConInterface),Renderer.init(Game._canvas,Game._engine.map(),c,Game),Game._engine.setup(),$("#end_turn").click(Game._controller.endTurn.bind(Game._controller)),$("#back_btn").click(Game._controller.historyBack.bind(Game._controller)),$("#forward_btn").click(Game._controller.historyForward.bind(Game._controller)),Game._engine.startTurn(0)},gameOver:function(a,b){},stateRendered:function(a,b){Game._controller.viewingHistory()||(Game._currentState=a,Game._controller&&Game._controller.update(a))},mouseOverCountry:function(a){Game._mapController.mouseOverCountry(a)},mapConInterface:{currentPlayerId:function(){return Game._currentState?Game._currentState.currentPlayerId():-1},attack:function(a,b,c){Game._engine.attack(a,b,c)},clickable:function(){return!Game._controller.viewingHistory()}}}});var GameRunner=function(a){this._engine=new Engine,this._players=a.map(function(a){return a}),this._callback=null,this._players.length<2&&debug("Not enough players: "+self.players)};GameRunner.prototype.start=function(a){var b=this;if(this._players.length>1){this._callback=a;var c=this._players.map(function(a,c){return new AIWrapper(a.hash,b._engine,c,!1,a.name)});this._engine.init(c),this._engine.setEnforceTime(!0),this._engine.registerGameCallback(this.gameDone.bind(this)),this._engine.registerStateCallback(this.engineUpdate.bind(this)),this._engine.setup(),this._gameId=uuid.v1(),this._uploader=new Uploader,this._uploader.uploadMap(this._gameId,this._engine.serializeMap()),debug("Beginning game "+this._gameId+": "+c.map(function(a){return a.getName()})),this._engine.startTurn(0)}else debug("Not enough players to play: "+JSON.stringify(this._players)),this._callback=null,this._gameId="",this._engine=null,this._players=null,this._uploader=null,a&&a()},GameRunner.prototype.stop=function(){this._engine&&(this._engine.registerStateCallback(null),delete this._engine,this._engine=null)},GameRunner.prototype.engineUpdate=function(a,b){var c=this;c._uploader.uploadState(c._gameId,b,a.toString());for(var d="Move number: "+a.stateId()+"<br><br>Scores:<br>",e=c._engine.playerCount(),f=0;e>f;f++){var g=c._engine.getPlayer(f);g&&(d+="Player "+f+": "+g.countryCount()+", "+g.timePerTurn()+"ms <br>")}$("#score").html(d),a.attack()&&window.setTimeout(function(){c._engine.finishAttack(a.attack())},0)},GameRunner.prototype.makeTable=function(a,b){return $.each(b,function(b,c){var d=$("<tr/>");$.each(c,function(a,c){0==b?d.append($("<th/>").text(c)):d.append($("<td id='"+b+a+"'/>").text(c))}),a.append(d)}),a},GameRunner.prototype.gameDone=function(a,b){var c=this;console.log("Game finished, winnerId",b);for(var d=[],e=c._engine.playerCount(),f=0;e>f;f++){var g=c._engine.getPlayer(f);g&&d.push(g.timePerTurn())}var h=new Gameinfo(c._players.map(function(a,b){return{id:a.hash,avgTime:d[b]}}),b);c._uploader.uploadGameInfo(c._gameId,h.toString(),"ARENA");var i=this._callback;this._engine=null,this._gameId="",this._players=null,this._uploader=null,this._callback=null,i&&i()};var debug=function(a){console.log(a)},RandomRunner=function(a,b){this._count=0,this._stop=!1,this._max=b||-1,this._players=a};RandomRunner.prototype.setMax=function(a){this._max=a},RandomRunner.prototype.start=function(){for(var a=[],b=1+Math.ceil(7*Math.random()),c=Globals.shuffleArray(this._players);c.length&&a.length<b;)a.push(c.shift());this._count++,this._runner=new GameRunner(a),console.log("game "+this._count+" starting"),$("#counter").html("Currently playing game "+this._count+" out of "+this._max),$("#status").html("Current Game: "+JSON.stringify(a.map(function(a){return a.name}))),this._runner.start(this.done.bind(this))},RandomRunner.prototype.stop=function(){this._stop=!0,this._runner&&(this._runner.stop(),delete this._runner,this._runner=null,$("#status").html("Stopped"))},RandomRunner.prototype.done=function(){console.log("game over"),this._runner=null,this._stop||this._max>0&&this._count>=this._max?(console.log("Exiting Thunderdome"),$("#status").html("Done"),$("#stop_btn").prop("disabled",!0),$("#start_btn").prop("disabled",!1),this._count=0):setTimeout(this.start.bind(this),0)},$(function(){window.Thunderdome={_AIs:[],_runner:null,_downloader:null,init:function(){Thunderdome._downloader=new Downloader,Thunderdome._downloader.getAIs(Thunderdome.aiListReceived),$("#stop_btn").prop("disabled",!0),$("#start_btn").prop("disabled",!0),$("#start_btn").click(Thunderdome.start),$("#stop_btn").click(Thunderdome.stop)},aiListReceived:function(a,b){a?b&&b.length&&($("#stop_btn").prop("disabled",!0),$("#start_btn").prop("disabled",!1),Thunderdome._AIs=b,Thunderdome._runner=new RandomRunner(Thunderdome._AIs,1)):console.log("ERROR retrieving AI list",b)},start:function(){$("#stop_btn").prop("disabled",!1),$("#start_btn").prop("disabled",!0);var a=$("#count").val();Thunderdome._runner.setMax(parseInt(a)),Thunderdome._runner.start()},stop:function(){$("#stop_btn").prop("disabled",!0),$("#start_btn").prop("disabled",!1),Thunderdome._runner.stop()}}});var Gamecontroller=function(a,b){this._playerId=a,this._historyIndex=0,this._historyLength=0,this._engine=b,this._lastState=null};$(function(){Gamecontroller.prototype.update=function(a){if(!Globals.suppress_ui){var b=this;a&&(b.viewingHistory()||(b._historyIndex=a.stateId()),b._lastState=a,b._historyLength=b._lastState.stateId()+1),$("#back_btn").prop("disabled",!0),$("#forward_btn").prop("disabled",!0),b._playerId==b._lastState.currentPlayerId()?(b.viewingHistory()?$("#end_turn").prop("disabled",!0):b._lastState.attack()?$("#end_turn").prop("disabled",!0):$("#end_turn").prop("disabled",!1),$("#history").html(b._historyIndex+1+" / "+b._historyLength),b.viewingHistory()&&$("#forward_btn").prop("disabled",!1),b._historyIndex>0&&$("#back_btn").prop("disabled",!1)):$("#end_turn").prop("disabled",!0)}},Gamecontroller.prototype.endTurn=function(){var a=this;Globals.ASSERT(a._lastState.stateId()==a._engine.getState().stateId()),a._historyIndex=a._lastState.stateId(),a._engine.endTurn()},Gamecontroller.prototype.historyBack=function(a){var b=this;b._historyIndex>0&&b._historyIndex--,b.renderHistory(b._engine.getHistory(b._historyIndex)),b.update()},Gamecontroller.prototype.historyForward=function(a){var b=this;b.viewingHistory()&&(b._historyIndex<b._engine.historyLength()-1&&b._historyIndex++,b.renderHistory(b._engine.getHistory(b._historyIndex)),b.update())},Gamecontroller.prototype.renderHistory=function(a){Renderer.renderHistory(a)},Gamecontroller.prototype.viewingHistory=function(){var a=this;return a._lastState?a._historyIndex<a._lastState.stateId():!1}});var HistoryController=function(a,b){this._history=a,this._playerId=b,this._viewingHistory=!1,this._currentlyViewing=0,this._latestStateId=0,$("#back_btn").click(this.historyBack.bind(this)),$("#forward_btn").click(this.historyForward.bind(this))};$(function(){HistoryController.prototype.updateStateCount=function(a){this._latestStateId=a,this.update()},HistoryController.prototype.setViewState=function(a){this._currentlyViewing=a,this.update()},HistoryController.prototype.update=function(){var a=this;$("#back_btn").prop("disabled",0==a._currentlyViewing),$("#forward_btn").prop("disabled",a._currentlyViewing==a._latestStateId),$("#history").html(a._currentlyViewing+" / "+a._latestStateId)},HistoryController.prototype.historyBack=function(a){var b=this;b._currentlyViewing>0&&(b._currentlyViewing--,b._viewingHistory=!0,b._history.getState(b._currentlyViewing,b.renderHistory.bind(b)),b.update())},HistoryController.prototype.historyForward=function(a){var b=this;b.viewingHistory()&&(b._currentlyViewing<b._latestStateId&&b._currentlyViewing++,b._currentlyViewing==b._latestStateId&&(b._viewingHistory=!1),b._history.getState(b._currentlyViewing,b.renderHistory.bind(b)),b.update())},HistoryController.prototype.renderHistory=function(a){Renderer.renderHistory(a)},HistoryController.prototype.viewingHistory=function(){var a=this;return a._viewingHistory}});var Mapcontroller=function(a,b,c){Globals.ASSERT(Globals["implements"](c,Mapcontroller.mapControllerInterface)),this._playerId=a,this._canvas=$("#c")[0],this._map=b,this._iface=c,this._mouseOverCountry=null,this._selectedCountry=null,$("#canvas_div").click(this.click.bind(this)),$("#canvas3d_div").click(this.click.bind(this))};Mapcontroller.mapControllerInterface={currentPlayerId:function(){},attack:function(a,b,c){},clickable:function(){}},$(function(){Mapcontroller.prototype.setPlayerId=function(a){this._playerId=a},Mapcontroller.prototype.getMouseOverCountry=function(){return this._mouseOverCountry},Mapcontroller.prototype.setMouseOverCountry=function(a){Globals.debug("SetMouseOverCountry",a?a.id():-1,Globals.LEVEL.INFO,Globals.CHANNEL.MAP_CONTROLLER),this._mouseOverCountry=a,Renderer.setMouseOverCountry(a?a.id():-1)},Mapcontroller.prototype.selectedCountry=function(){return this._selectedCountry},Mapcontroller.prototype.setSelectedCountry=function(a){Globals.debug("setSelectedCountry",a?a.id():-1,Globals.LEVEL.INFO,Globals.CHANNEL.MAP_CONTROLLER),this._selectedCountry=a,Renderer.setSelectedCountry(a?a.id():-1)},Mapcontroller.prototype.canAttack=function(a,b){var c=this;if(!a||!b||a.ownerId()==b.ownerId())return!1;for(var d=c._map.adjacentCountries(a.id()),e=0;e<d.length;e++)if(d[e]==b.id())return!0;return!1},Mapcontroller.prototype.isCountryClickable=function(a){return a&&this._playerId==this._iface.currentPlayerId()?this.selectedCountry()&&a.id()==this.selectedCountry().id()?!0:!this.selectedCountry()&&a.ownerId()==this._iface.currentPlayerId()&&a.numDice()>1?!0:(a.ownerId()!=this._iface.currentPlayerId()&&Globals.debug("NOT this players' country",Globals.LEVEL.DEBUG,Globals.CHANNEL.MAP_CONTROLLER),a.numDice()<=1&&Globals.debug("NOT enough dice to attack",Globals.LEVEL.DEBUG,Globals.CHANNEL.MAP_CONTROLLER),this.canAttack(this.selectedCountry(),a)?!0:(Globals.debug(a.id(),"NOT clickable",Globals.LEVEL.DEBUG,Globals.CHANNEL.MAP_CONTROLLER),!1)):!1},Mapcontroller.prototype.mouseOverCountry=function(a){if(this._iface.clickable()){var b=this._map.getCountry(a);b&&this.isCountryClickable(b)?this.getMouseOverCountry()!==b&&(this.setMouseOverCountry(b),this._canvas.style.cursor="pointer"):(this.getMouseOverCountry()&&this.setMouseOverCountry(null),this._canvas.style.cursor="default")}},Mapcontroller.prototype.click=function(a){if(this._iface.clickable()){var b=this,c=b._iface.currentPlayerId();if(b._playerId==c){var d=b.getMouseOverCountry();if(d&&b.isCountryClickable(d))if(d.ownerId()==c&&d.numDice()>1)if(b.selectedCountry()==d)b.setSelectedCountry(null);else{b.selectedCountry();b.setSelectedCountry(d)}else{Globals.debug("attack issued",Globals.LEVEL.INFO,Globals.CHANNEL.MAP_CONTROLLER);var e=b.selectedCountry();b.setSelectedCountry(null),
b.setMouseOverCountry(null),b._iface.attack(e,d,function(){b.setSelectedCountry(null),$("#end_turn").prop("disabled",!1)})}else Globals.debug(d?d.id():"null","Country not clickable",Globals.LEVEL.DEBUG,Globals.CHANNEL.MAP_CONTROLLER)}else if(Globals.debug("current player isn't human",Globals.LEVEL.DEBUG,Globals.CHANNEL.MAP_CONTROLLER),b.selectedCountry()){b.selectedCountry();b.setSelectedCountry(null)}}}});var SocketAIController=function(a,b,c,d){this._socket=a,this._ai=c,this._id=d,this._history=b,this._started=!1,this._isMyTurn=!1,this._startTurnPending=!1,this._startTurnPendingStateId=-1,this._attackPending=!1,this._aiWrapper=null,this.initAI(),a.on(Message.TYPE.START_TURN,this.start_turn.bind(this)),a.on(Message.TYPE.ATTACK_RESULT,this.attack_result.bind(this)),Globals.ASSERT(Globals["implements"](this,Engine.PlayerWrapper)),Globals.ASSERT(Globals["implements"](this,Engine.ControllerInterface))};if(SocketAIController.prototype.initAI=function(){this._aiWrapper&&(this._aiWrapper.stop(),this._aiWrapper=null),this._aiWrapper=new AIWrapper(this._ai,this,this._id,!1)},SocketAIController.prototype.start_turn=function(a,b){b.playerId==this._id&&this.startTurn(b.stateId)},SocketAIController.prototype.attack_result=function(a,b){var c=this;b.playerId==c._id&&c._attackPending&&c._history.getState(b.stateId,function(a){c.attackDone(b.success,b.stateId)})},SocketAIController.prototype.getName=function(){return this._aiWrapper.getName()},SocketAIController.prototype.isHuman=function(){return!1},SocketAIController.prototype.start=function(){this._started||(this._started=!0,this._aiWrapper.start(),this._startTurnPending&&(this._startTurnPending=!1,this.startTurn(this._startTurnPendingStateId),this._startTurnPendingStateId=-1))},SocketAIController.prototype.stop=function(){this._started=!1,this._isMyTurn=!1,this._socket.removeListener(Message.TYPE.START_TURN,this.start_turn),this._socket.removeListener(Message.TYPE.ATTACK_RESULT,this.attack_result),this._aiWrapper.stop()},SocketAIController.prototype.startTurn=function(a){var b=this;b._started?b._history.getState(a,function(a){b._isMyTurn&&Globals.debug("Got startTurn when it was already our turn",Globals.LEVEL.WARN,Globals.CHANNEL.CLIENT),b._isMyTurn=!0;try{b._aiWrapper.startTurn(a)}catch(c){Globals.debug("AIWrapper.startTurn exception. Attempting to re-initialize",c,Globals.LEVEL.ERROR,Globals.CHANNEL.CLIENT),b.initAI(),b._aiWrapper.start(),b._aiWrapper.startTurn(a)}}):(b._startTurnPending=!0,b._startTurnPendingStateId=a)},SocketAIController.prototype.attackDone=function(a,b){if(this._attackPending){this._attackPending=!1;try{this._aiWrapper.attackDone(a)}catch(c){Globals.debug("AIWrapper.attackDone exception. Attempting to re-initialize",c,Globals.LEVEL.ERROR,Globals.CHANNEL.CLIENT),self.initAI(),self._aiWrapper.start(),self.startTurn(b)}}},SocketAIController.prototype.turnEnded=function(){this._attackPending=!1,this._isMyTurn=!1,this._aiWrapper.turnEnded()},SocketAIController.prototype.loses=function(){this._aiWrapper.loses()},SocketAIController.prototype.map=function(){return Globals.ASSERT(Client._map),Client._map},SocketAIController.prototype.getState=function(){return Client._history.getLatest()},SocketAIController.prototype.endTurn=function(a){this._isMyTurn?(this._isMyTurn=!1,this._socket.sendEndTurn(this._id)):Globals.debug("AI tried to end turn when it wasn't our turn",Globals.LEVEL.WARN,Globals.CHANNEL.CLIENT)},SocketAIController.prototype.attack=function(a,b,c){this._isMyTurn?(this._attackPending=!0,this._socket.sendAttack(a.id(),b.id(),this._id)):Globals.debug("AI tried to attack when it wasn't our turn",Globals.LEVEL.WARN,Globals.CHANNEL.CLIENT)},"function"==typeof importScripts){importScripts("/js/globals.js"),importScripts("/js/game/gamestate.js"),importScripts("/js/ai/util.js"),importScripts("/_replaceThisWithAIHash_");var createAIByName=function(name,playerId){return eval("ai"+name).create(playerId)},adjacencyList=null,state=null,ai=null,attackCallback=null;onmessage=function(a){var b=a.data;switch(b.command){case"init":adjacencyList=b.adjacencyList;var c=b.playerId;ai=createAIByName(b.ai,c);break;case"startTurn":state=Gamestate.deserialize(b.state),ai.startTurn(AIInterface());break;case"attackResult":state=Gamestate.deserialize(b.state),attackCallback(b.result)}};var AIInterface=function(){return{adjacentCountries:function(a){return adjacencyList[a]},getState:function(){return state},attack:function(a,b,c){attackCallback=c,postMessage({command:"attack",from:a,to:b})},endTurn:function(){postMessage({command:"endTurn"})}}}}if("undefined"!=typeof module&&module.exports)var Globals=require("../globals.js"),Gamestate=require("./gamestate.js");var AIInterface=function(a){var b=a._controller;return{adjacentCountries:function(a){return b.map().adjacentCountries(a)},getState:function(){return b.getState()},attack:function(b,c,d){a.attack(b,c,d)},endTurn:function(){a.endTurn()}}},AIWrapper=function(a,b,c,d,e){Globals.debug("AIWrapper()","string"==typeof a?a:a.getName(),c,d,e,Globals.LEVEL.INFO,Globals.CHANNEL.AI_WRAPPER),Globals.ASSERT(Globals["implements"](b,Engine.ControllerInterface)),this._test=d,this._isMyTurn=!1,this._controller=b,this._id=c,"string"==typeof a?(Globals.ASSERT(e),this._trusted=!1,this._ai=null,this._aiHash=a,this._name=e):(this._trusted=!0,this._name=a.getName()),this._trusted&&(this._ai=a.create(c)),Globals.ASSERT(Globals["implements"](this,Engine.PlayerInterface))};if(AIWrapper.prototype.getName=function(){return this._name},AIWrapper.prototype.isHuman=function(){return!1},AIWrapper.prototype.start=function(){if(Globals.debug("AIWrapper.start()",this._name,Globals.LEVEL.INFO,Globals.CHANNEL.AI_WRAPPER),!this._trusted){if(this._aiHash){var a=(this._test?"/testworker/":"/aiworker/")+this._aiHash;Globals.debug("Downloading new aiworker",a,Globals.LEVEL.INFO,Globals.CHANNEL.AI_WRAPPER),this._worker=new Worker(a)}else Globals.debug("Creating new botworker",Globals.LEVEL.INFO,Globals.CHANNEL.AI_WRAPPER),this._worker=new Worker("/js/game/botworker.js");this._worker.onmessage=this.callback.bind(this),this._worker.postMessage({command:"init",adjacencyList:this._controller.map().adjacencyList(),ai:this._aiHash?this._aiHash:this._name,playerId:this._id})}},AIWrapper.prototype.stop=function(){!this._trusted&&this._worker&&(this._worker.terminate(),this._worker=null)},AIWrapper.prototype.startTurn=function(a){Globals.ASSERT(!this._isMyTurn),this._isMyTurn=!0,this._trusted?(Globals.ASSERT(this._ai),this._ai.startTurn(AIInterface(this))):(Globals.ASSERT(this._worker),this._worker.postMessage({command:"startTurn",state:a.serialize()}))},AIWrapper.prototype.attackDone=function(a){this._trusted?this._aiCallback(a):(Globals.ASSERT(this._worker),this._worker.postMessage({command:"attackResult",result:a,state:this._controller.getState().serialize()}))},AIWrapper.prototype.turnEnded=function(){this._isMyTurn=!1},AIWrapper.prototype.loses=function(){this._trusted?this._ai=null:(this._worker.close(),this._worker=null)},AIWrapper.prototype.endTurn=function(){this._isMyTurn&&(this._isMyTurn=!1,this._controller.endTurn())},AIWrapper.prototype.attack=function(a,b,c){this._isMyTurn&&(this._aiCallback=c,this._controller.attack(this._controller.map().getCountry(a),this._controller.map().getCountry(b),this.attackDone.bind(this)))},AIWrapper.prototype.callback=function(a){if(this._isMyTurn){var b=a.data;switch(b.command){case"attack":var c=parseInt(b.from),d=parseInt(b.to);this._controller.attack(this._controller.map().getCountry(c),this._controller.map().getCountry(d),this.attackDone.bind(this));break;case"endTurn":this._isMyTurn=!1,this._controller.endTurn()}}},"undefined"!=typeof module&&module.exports&&(module.exports=AIWrapper),"function"==typeof importScripts){importScripts("/js/globals.js"),importScripts("/js/game/gamestate.js"),importScripts("/js/ai/util.js"),importScripts("/js/ai/plyer.js"),importScripts("/js/ai/greedy.js"),importScripts("/js/ai/aggressive.js");var initAIs=function(){aiMap[AI.Plyer.getName()]=AI.Plyer,aiMap[AI.Greedy.getName()]=AI.Greedy,aiMap[AI.Aggressive.getName()]=AI.Aggressive},createAIByName=function(a,b){return aiMap[a].create(b)},adjacencyList=null,state=null,ai=null,attackCallback=null,aiMap={};initAIs(),onmessage=function(a){var b=a.data;switch(b.command){case"init":adjacencyList=b.adjacencyList;var c=b.playerId;ai=createAIByName(b.ai,c);break;case"startTurn":state=Gamestate.deserialize(b.state),ai.startTurn(AIInterface());break;case"attackResult":state=Gamestate.deserialize(b.state),attackCallback(b.result)}};var AIInterface=function(){return{adjacentCountries:function(a){return adjacencyList[a]},getState:function(){return state},attack:function(a,b,c){attackCallback=c,postMessage({command:"attack",from:a,to:b})},endTurn:function(){postMessage({command:"endTurn"})}}}}if("undefined"!=typeof module&&module.exports)var Globals=require("../globals.js"),Hex=require("./hex.js");var Country=function(a){this._id=a,this._hexIds=[],this._ownerId=-1,this._numDice=1,Globals.debug("Constructed country",this,Globals.LEVEL.TRACE,Globals.CHANNEL.COUNTRY)};if(Country.MAX_HEXES=100,Country.MIN_HEXES=30,Country.prototype.clone=function(){var a=new Country(this._id);return a._hexIds=JSON.parse(JSON.stringify(this._hexIds)),a._ownerId=this._ownerId,a._numDice=this._numDice,a},Country.prototype.getState=function(){var a={id:this._id,owner:this._ownerId,numDice:this.numDice()};return a},Country.prototype.setState=function(a,b){this._ownerId=a.countryOwner(b),this.setNumDice(a.countryDice(b))},Country.prototype.setOwner=function(a){Globals.ASSERT("object"!=typeof a),this._ownerId=a},Country.prototype.setNumDice=function(a){Globals.ASSERT(a>0&&8>=a),this._numDice=a},Country.prototype.id=function(){return this._id},Country.prototype.ownerId=function(){return this._ownerId},Country.prototype.hexes=function(){return this._hexIds},Country.prototype.isLake=function(){return this._isLake},Country.prototype.numDice=function(){return this._numDice},Country.prototype.addDie=function(){this._numDice<8&&this._numDice++},Country.prototype.removeDie=function(){this._numDice>1&&this._numDice--},"undefined"!=typeof module&&module.exports&&(module.exports=Country),"undefined"!=typeof module&&module.exports)var Globals=require("../globals.js"),Hex=require("./hex.js");var Dir={obj:{NW:0,N:1,NE:2,SE:3,S:4,SW:5},array:["NW","N","NE","SE","S","SW"],isLegal:function(a,b){switch(b){case Dir.obj.N:case"N":return a.id()-2*Hex.NUM_WIDE>=0;case Dir.obj.NE:case"NE":case Dir.obj.SE:case"SE":return(a.id()+1)%(2*Hex.NUM_WIDE);case Dir.obj.S:case"S":return a.id()+2*Hex.NUM_WIDE<Hex.TOTAL_HEXES;case Dir.obj.NW:case"NW":case Dir.obj.SW:case"SW":return a.id()%(2*Hex.NUM_WIDE);default:return!1}},nextHex:function(a,b,c){if(!Dir.isLegal(a,b))return null;var d,e=(a.x(),a.y(),a.id());switch(b){case Dir.obj.NW:case"NW":d=Math.floor(e/Hex.NUM_WIDE)%2?e-Hex.NUM_WIDE:e-Hex.NUM_WIDE-1;break;case Dir.obj.N:case"N":d=e-2*Hex.NUM_WIDE;break;case Dir.obj.NE:case"NE":d=Math.floor(e/Hex.NUM_WIDE)%2?e-Hex.NUM_WIDE+1:e-Hex.NUM_WIDE;break;case Dir.obj.SE:case"SE":d=Math.floor(e/Hex.NUM_WIDE)%2?e+Hex.NUM_WIDE+1:e+Hex.NUM_WIDE;break;case Dir.obj.S:case"S":d=e+2*Hex.NUM_WIDE;break;case Dir.obj.SW:case"SW":d=Math.floor(e/Hex.NUM_WIDE)%2?e+Hex.NUM_WIDE:e+Hex.NUM_WIDE-1}return c.getHex(d)}};if("undefined"!=typeof module&&module.exports&&(module.exports=Dir),"undefined"!=typeof module&&module.exports)var Globals=require("../globals.js"),Map=require("./map.js"),Country=require("./country.js"),Player=require("./player.js"),Gamestate=require("./gamestate.js"),AIWrapper=require("./aiwrapper.js");var MOVE_TIME_BUDGET=2e3,Engine=function(){this._AIs=null,this._currentPlayerId=0,this._gameOver=!1,this._history=[],this._players=[],this._gameCallback=null,this._stateCallback=null,this._attackCallback=null,this._keepHistory=!0,this._stateCount=0,this._initialized=!1,this._map=null,this._enforceTimeLimits=!1,Globals.ASSERT(Globals["implements"](this,Engine.ControllerInterface))};if(Engine.PlayerInterface={getName:function(){return"human"},isHuman:function(){return!0},start:function(){},stop:function(){},startTurn:function(a){},attackDone:function(a,b){},turnEnded:function(){},loses:function(){}},Engine.ControllerInterface={map:function(){},getState:function(){},endTurn:function(){},attack:function(a,b,c){}},Engine.prototype.map=function(){return this._map},Engine.prototype.getPlayer=function(a){return this._players[a]},Engine.prototype.currentPlayer=function(){return this._players[this._currentPlayerId]},Engine.prototype.currentPlayerId=function(){return this._currentPlayerId},Engine.prototype.isInitialized=function(){return this._initialized},Engine.prototype.setKeepHistory=function(a){this._keepHistory=a},Engine.prototype.setEnforceTime=function(a){this._enforceTimeLimits=a},Engine.prototype.currentStateId=function(){return this._history.length?this._history[this._history.length-1].stateId():0},Engine.prototype.setCurrentPlayer=function(a){Globals.debug("Current player set to "+a,Globals.LEVEL.DEBUG,Globals.CHANNEL.ENGINE),this._currentPlayerId=a},Engine.prototype.init=function(a,b){console.time("DICEFIRE"),a.forEach(function(a){Globals.ASSERT(Globals["implements"](a,Engine.PlayerInterface))}),Globals.debug("Engine init",a.map(function(a){return a.getName()}),Globals.LEVEL.INFO,Globals.CHANNEL.ENGINE);var c=this;c._history=[],c._stateCount=0,c.setCurrentPlayer(0),c._gameOver=!1,c._gameCallback=null,c._stateCallback=null,c._AIs&&c._AIs.forEach(function(a){a.stop()}),c._AIs=[],c._AIs.length=a.length,c._players=[];for(var d=0;d<a.length;d++)c._players.push(new Player(d,c)),c._AIs[d]=a[d];c._map=new Map,b?(Globals.debug("Using provided map",Globals.LEVEL.INFO,Globals.CHANNEL.ENGINE),c._map.deserializeHexes(b)):(c._map.generateMap(),Globals.debug("Map: "+c._map.serializeHexes(),Globals.LEVEL.TRACE,Globals.CHANNEL.ENGINE)),c._map.assignCountries(c._players),c._initialized=!0},Engine.prototype.registerStateCallback=function(a){this._stateCallback=a},Engine.prototype.registerGameCallback=function(a){this._gameCallback=a},Engine.prototype.setup=function(a){Globals.debug("Engine setup",Globals.LEVEL.INFO,Globals.CHANNEL.ENGINE);var b=this;b._AIs.forEach(function(a){a.start()}),a?(Globals.debug("Using provided initial state",Globals.LEVEL.INFO,Globals.CHANNEL.ENGINE),b.deserialize(JSON.parse(a))):(b.pushHistory(),b._players.forEach(function(a){b.addDiceToPlayer(a,Globals.startingDice)})),b._players.forEach(function(a){a.updateStatus(b._map)})},Engine.prototype.pushHistory=function(a){var b=this,c=b._stateCount;b._stateCount++;var d=new Gamestate(b._players,b._map._countryArray,b._currentPlayerId,c);a&&d.setAttack(a),b._keepHistory?b._history.push(d):b._history=[d],b._stateCallback&&b._stateCallback(d,c)},Engine.prototype.addDiceToPlayer=function(a,b){var c=this;b+=a._storedDice,a._storedDice=0;for(var d,e=0;b>e;e++){if(d=a.countriesWithSpace(c._map),0==d.length){a._storedDice+=b-e,a._storedDice>Globals.maxStoredDice&&(a._storedDice=Globals.maxStoredDice);break}var f=d[Math.floor(Math.random()*d.length)];f.addDie()}},Engine.prototype.isHuman=function(a){return this._AIs[a].isHuman()},Engine.prototype.startTurn=function(a,b){Globals.debug("Player "+a+" starting turn",Globals.LEVEL.INFO,Globals.CHANNEL.ENGINE);var c=this;c.setCurrentPlayer(a),c.pushHistory(),c._timeout(function(){!c.isHuman(a)&&c._enforceTimeLimits&&(c._players[a].setTimeBudget(MOVE_TIME_BUDGET),c._startClock(a)),c._AIs[c._currentPlayerId].startTurn(c.getState()),c._players[c._currentPlayerId].turnStarted()},0)},Engine.prototype.endTurn=function(){Globals.debug("Player "+this._currentPlayerId+" ending turn",Globals.LEVEL.INFO,Globals.CHANNEL.ENGINE);var a=this;a._stopClock(a._currentPlayerId);var b=a._currentPlayerId,c=a._players[a._currentPlayerId];a.addDiceToPlayer(c,c._numContiguousCountries),a._players[a._currentPlayerId].turnEnded();do b++,b>=a._AIs.length&&(b=0);while(this._players[b].hasLost()&&b!==a._currentPlayerId);b==a._currentPlayerId?a.gameOver(c):a.startTurn(b)},Engine.prototype.attack=function(a,b,c){var d=this;"number"==typeof a&&(a=d._map.getCountry(a)),"number"==typeof b&&(b=d._map.getCountry(b));var e=d._players[a.ownerId()];d._players[b.ownerId()];if(e.id()!=d._currentPlayerId)return Globals.debug("Attacking player not current player",Globals.LEVEL.DEBUG,Globals.CHANNEL.ENGINE),void(d._attackCallback&&d._attackCallback(!1,d.currentStateId()));Globals.debug("Attack FROM",a._id,"TO",b._id,Globals.LEVEL.DEBUG,Globals.CHANNEL.ENGINE),d._stopClock(d._currentPlayerId),d._attackCallback=c;for(var f=d._map.adjacentCountries(a.id()),g=!1,h=0;h<f.length;h++)if(f[h]==b.id()){g=!0;break}if(a.numDice()<2&&(Globals.debug("Attacking country has too few dice",Globals.LEVEL.DEBUG,Globals.CHANNEL.ENGINE),g=!1),a.ownerId()==b.ownerId()&&(Globals.debug("Player attacking itself",Globals.LEVEL.DEBUG,Globals.CHANNEL.ENGINE),g=!1),a.id()==b.id()&&(Globals.debug("Country attacking itself",Globals.LEVEL.DEBUG,Globals.CHANNEL.ENGINE),g=!1),g){var i=a.numDice(),j=b.numDice(),k=Player.rollDice(i),l=Player.rollDice(j);Globals.ASSERT(k&&k.length>1),Globals.ASSERT(i==k.length),Globals.debug("Attack roll",k,Globals.LEVEL.DEBUG,Globals.CHANNEL.ENGINE),Globals.debug("Defend roll",l,Globals.LEVEL.DEBUG,Globals.CHANNEL.ENGINE);var m=k.reduce(function(a,b){return a+b},0),n=l.reduce(function(a,b){return a+b},0),o={fromCountryId:a._id,toCountryId:b._id,fromRollArray:k,toRollArray:l};if(d.pushHistory(o),a.setNumDice(1),m>n){Globals.debug("Attacker wins",Globals.LEVEL.DEBUG,Globals.CHANNEL.ENGINE);var p=d._players[b.ownerId()];if(b.setNumDice(i-1),e.addCountry(b),p.loseCountry(b),p.updateStatus(d._map),e.updateStatus(d._map),Globals.debug("Losing player has "+p.countryCount()+" countries left",Globals.LEVEL.INFO,Globals.CHANNEL.ENGINE),p.hasLost()&&Globals.debug("Player "+p.id()+" has lost and can no longer play",Globals.LEVEL.INFO,Globals.CHANNEL.ENGINE),e.countryCount()==d._map.countryCount())return void d.gameOver(e)}else Globals.debug("Attacker loses",Globals.LEVEL.DEBUG,Globals.CHANNEL.ENGINE);if(d.pushHistory(),d._startClock(d._currentPlayerId),d._attackCallback){var q=d._attackCallback;d._attackCallback=null,q(m>n,d.currentStateId())}}else Globals.debug("Illegal attack",a.id(),b.id(),Globals.LEVEL.DEBUG,Globals.CHANNEL.ENGINE),d._attackCallback&&d._attackCallback(!1,d.currentStateId()),d._startClock(d._currentPlayerId)},Engine.prototype.penalizePlayer=function(a){var b=this;if(b._enforceTimeLimits)if(a==b._currentPlayerId){if(!b._AIs[a].isHuman())if(Globals.timePenalties){Globals.debug("Penalizing player",a,Globals.LEVEL.INFO,Globals.CHANNEL.ENGINE);var c=b._players[a];if(c.storedDice())c.removeStoredDie();else{var d=c.countries().map(function(a){return b._map.getCountry(a)}).filter(function(a){return a.numDice()>1});if(d.length){var e=Math.floor(d.length*Math.random());Globals.debug("Removing die from country",d[e].id(),Globals.LEVEL.DEBUG,Globals.CHANNEL.ENGINE),d[e].removeDie()}else Globals.debug("Player has no more dice to remove",a,Globals.LEVEL.INFO,Globals.CHANNEL.ENGINE),b._AIs[a].turnEnded(),b.endTurn()}}else Globals.debug("Player over time limit - ending turn",a,Globals.LEVEL.INFO,Globals.CHANNEL.ENGINE),b._AIs[a].turnEnded(),b.endTurn()}else Globals.debug("PenalizePlayer called for non-current player",a,Globals.LEVEL.WARN,Globals.CHANNEL.ENGINE)},Engine.prototype.gameOver=function(a){var b=this;b._gameOver||(console.log("GAME OVER"),b.pushHistory(),b._gameOver=!0,console.timeEnd("DICEFIRE"),b._AIs.forEach(function(a){a&&a instanceof AIWrapper&&a.stop()}),b._gameCallback&&b._gameCallback(b._AIs[a.id()].getName(),a.id()))},Engine.prototype.isGameOver=function(){return this._gameOver},Engine.prototype.deserialize=function(a){var b=Gamestate.deserialize(a);this.setState(b)},Engine.prototype.serializeMap=function(){return this._map.serializeHexes()},Engine.prototype.historyLength=function(){return this._history.length},Engine.prototype.getHistory=function(a){return a>=0&&a<this._history.length?this._history[a]:new Gamestate},Engine.prototype.getState=function(){return this._history.length?this._history[this._history.length-1]:null},Engine.prototype.setState=function(a){var b=this;b._map.setState(a),b._players=[],b._players.length=a.playerIds().length,a.playerIds().forEach(function(c){var d=new Player(c,b);d._countries=[],a.countryIds().forEach(function(a){var e=b._map.getCountry(a);e.ownerId()==c&&d._countries.push(a)}),d._storedDice=a.storedDice(c),d._numContiguousCountries=a.numContiguous(c),b._players[c]=d,Globals.debug("Deserialized player",c,Globals.LEVEL.INFO,Globals.CHANNEL.ENGINE)}),b._stateCount=a.stateId(),b.setCurrentPlayer(a.currentPlayerId())},Engine.prototype.playerCount=function(){return this._players?this._players.length:0},Engine.prototype.playerCountryCount=function(a){return this._players[a]._countries.length},Engine.prototype.totalCountryCount=function(){return this._map.countryCount()},Engine.prototype._timeout=function(a,b){return"undefined"!=typeof module&&module.exports?setTimeout(a,b):window.setTimeout(a,b)},Engine.prototype._startClock=function(a){var b=this;b._enforceTimeLimits&&!b._AIs[a].isHuman()&&b._players[a].startClock()},Engine.prototype._stopClock=function(a){var b=this;b._enforceTimeLimits&&!b._AIs[a].isHuman()&&b._players[a].stopClock()},"undefined"!=typeof module&&module.exports&&(module.exports=Engine),"undefined"!=typeof module&&module.exports)var Globals=require("../globals");var Gameinfo=function(a,b){Globals.ASSERT(a[0]instanceof Object),Globals.ASSERT(a[0].hasOwnProperty("id"));var c=this;"undefined"!=typeof b&&(c.winner=b),c.players=[],c.playerMap={},a.forEach(function(a,b){c.players.push(JSON.parse(JSON.stringify(a))),c.playerMap[a.id]=b})};if(Gameinfo.prototype.getWinner=function(){return this.winner},Gameinfo.prototype.setPlayerName=function(a,b){a<this.players.length&&(this.players[a].id=b)},Gameinfo.prototype.getPlayers=function(){return this.players.map(function(a){return a.id})},Gameinfo.prototype.avgTime=function(a){return this.players[a].avgTime},Gameinfo.prototype.setTimestamp=function(a){this.timestamp=a},Gameinfo.prototype.getTimestamp=function(){return this.timestamp},Gameinfo.prototype.setEloPreRating=function(a,b){var c=this.playerMap[a];"number"==typeof c&&this.players[c]&&(this.players[c].eloPreRating=b)},Gameinfo.prototype.setEloPostRating=function(a,b){var c=this.playerMap[a];"number"==typeof c&&this.players[c]&&(this.players[c].eloPostRating=b)},Gameinfo.prototype.getEloPostRating=function(a){var b=this.playerMap[a];return"number"==typeof b&&this.players[b]?this.players[b].eloPostRating:void 0},Gameinfo.prototype.hasBeenRated=function(){return this.players[0]&&this.players[0].eloPostRating},Gameinfo.prototype.serialize=function(){var a={winner:this.winner,players:JSON.parse(JSON.stringify(this.players)),timestamp:this.timestamp?this.timestamp:0};return a},Gameinfo.deserialize=function(a){if(a&&a.players){var b=new Gameinfo(a.players,a.winner);return b.timestamp=a.timestamp?a.timestamp:0,b}return null},Gameinfo.prototype.toString=function(){return JSON.stringify(this.serialize())},Gameinfo.fromString=function(a){return Gameinfo.deserialize(JSON.parse(a))},"undefined"!=typeof module&&module.exports&&(module.exports=Gameinfo),"undefined"!=typeof module&&module.exports)var Globals=require("../globals.js"),Hashes=require("jshashes");if(Hashes)var SHA1=new Hashes.SHA1;var Gamestate=function(a,b,c,d,e){var f=this;f._currentPlayerId="undefined"==typeof c?-1:c,f._players={},f._countries={},f._stateId=d,f._attack=null,a&&a.forEach(function(a){f._players[a.id()]={id:a.id(),hasLost:a.hasLost(),storedDice:a.storedDice(),numContiguousCountries:a.numContiguousCountries()}}),b&&b.forEach(function(a){f._countries[a.id()]={id:a.id(),owner:a.ownerId(),numDice:a.numDice()}}),e&&(Globals.ASSERT(e.fromCountryId>=0),f._attack=e)};if(Gamestate.prototype.serialize=function(){return JSON.parse(this.toString())},Gamestate.deserialize=function(a){var b=Gamestate.prototype.clone.call(a);return b},Gamestate.prototype.clone=function(){var a=new Gamestate;return a._currentPlayerId=this._currentPlayerId,a._stateId=this._stateId,a._players=JSON.parse(JSON.stringify(this._players)),a._countries=JSON.parse(JSON.stringify(this._countries)),a._attack=this._attack?JSON.parse(JSON.stringify(this._attack)):null,a._players&&Object.keys(a._players).forEach(function(a){"true"===a.hasLost?a.hasLost=!0:"false"===a.hasLost&&(a.hasLost=!1)}),a},Gamestate.prototype.toString=function(){return JSON.stringify(this)},Gamestate.prototype.playerCountries=function(a){var b=this,c={},d=-1;return Object.keys(b._countries).forEach(function(e){e=Number(e),Globals.ASSERT(e>d),d=e,b._countries[e].owner==a&&(c[e]=e)}),c},Gamestate.prototype.playerIds=function(){return Object.keys(this._players)},Gamestate.prototype.players=function(){return this._players},Gamestate.prototype.stateId=function(){return this._stateId},Gamestate.prototype.currentPlayerId=function(){return this._currentPlayerId},Gamestate.prototype.setCurrentPlayerId=function(a){this._currentPlayerId=a},Gamestate.prototype.playerHasLost=function(a){return this._players[a].hasLost},Gamestate.prototype.setPlayerHasLost=function(a,b){this._players[a].hasLost=b},Gamestate.prototype.storedDice=function(a){return this._players[a].storedDice},Gamestate.prototype.setPlayerHasLost=function(a,b){this._players[a].storedDice=b},Gamestate.prototype.storedDice=function(a){return this._players[a].storedDice},Gamestate.prototype.setPlayerHasLost=function(a,b){this._players[a].storedDice=b},Gamestate.prototype.numContiguous=function(a){return this._players[a].numContiguousCountries},Gamestate.prototype.setNumContiguous=function(a,b){this._players[a].numContiguousCountries=b},Gamestate.prototype.countryIds=function(){return Object.keys(this._countries)},Gamestate.prototype.countries=function(){return this._countries||(this._countries={}),JSON.parse(JSON.stringify(this._countries))},Gamestate.prototype.countryOwner=function(a){return Globals.ASSERT(this._countries[a]),this._countries[a].owner},Gamestate.prototype.setCountryOwner=function(a,b){this._countries[a].owner=b},Gamestate.prototype.countryDice=function(a){return this._countries[a].numDice},Gamestate.prototype.setCountryDice=function(a,b){this._countries[a].numDice=b},Gamestate.prototype.setAttack=function(a){Globals.ASSERT(a.fromCountryId>=0),this._attack=a},Gamestate.prototype.attack=function(){return this._attack?JSON.parse(JSON.stringify(this._attack)):null},Gamestate.prototype.playerHash=function(a){return this._players&&this._players[a]&&SHA1?SHA1.hex(JSON.stringify(this._players[a])):-1},Gamestate.prototype.countryHash=function(a){return this._countries[a]&&SHA1?SHA1.hex(JSON.stringify(this._countries[a])):-1},Gamestate.prototype.countriesHash=function(){return SHA1?SHA1.hex(JSON.stringify(this._countries)):-1},"undefined"!=typeof module&&module.exports&&(module.exports=Gamestate),"undefined"!=typeof module&&module.exports)var Globals=require("../globals.js");var Hex=function(a,b,c,d,e){this._id=a,this._x=this._id%Hex.NUM_WIDE,this._y=Math.floor(this._id/Hex.NUM_WIDE),this._countryId=-1,this._pruned=!1,this._countryEdgeDirections=[],"undefined"!=typeof b&&(this._x=b),"undefined"!=typeof c&&(this._y=c),"undefined"!=typeof d&&(this._countryId=d),"undefined"!=typeof e&&(this._countryEdgeDirections=e),Globals.debug("Constructed hex",this,Globals.LEVEL.TRACE,Globals.CHANNEL.HEX)};if(Hex.BORDER_THICKNESS=3,Hex.EDGE_LENGTH=8,Hex.HEIGHT=Hex.EDGE_LENGTH*Math.sqrt(3),Hex.TOP_LEFT_X=10,Hex.TOP_LEFT_Y=10,Hex.NUM_WIDE=40,Hex.NUM_HIGH=80,Hex.TOTAL_HEXES=Hex.NUM_WIDE*Hex.NUM_HIGH,Hex.FUDGE=.5,Hex.prototype.clone=function(){var a=new Hex(this._id,this._x,this._y,JSON.parse(JSON.stringify(this._countryEdgeDirections)));return a._countryId=this._countryId,a},Hex.prototype.id=function(){return this._id},Hex.prototype.x=function(){return this._x},Hex.prototype.y=function(){return this._y},Hex.prototype.hasCountry=function(){return-1!=this._countryId},Hex.prototype.setCountry=function(a){Globals.debug("Set country for hex",this,a,Globals.LEVEL.TRACE,Globals.CHANNEL.HEX),this._countryId=a?a._id:-1},Hex.prototype.countryId=function(){return this._countryId},Hex.prototype.setCountryEdgeDirections=function(a){Globals.debug("Set countryEdgeDirections",this,a,Globals.LEVEL.TRACE,Globals.CHANNEL.HEX),this._countryEdgeDirections=a},Hex.prototype.countryEdgeDirections=function(){return this._countryEdgeDirections},Hex.prototype.isInterior=function(){return 0===this._countryEdgeDirections.length},Hex.prototype.isExterior=function(){return this._countryEdgeDirections.length>0},Hex.prototype.center=function(){var a=this.upperLeft();return a[0]+=Math.floor(Hex.EDGE_LENGTH/2),a[1]+=Math.floor(Hex.HEIGHT/2),a},Hex.prototype.upperLeft=function(){var a,b,c;return this._y%2?(c=Math.floor(this._y/2),a=Hex.TOP_LEFT_X+Hex.EDGE_LENGTH*(3*(this._x+.5)),b=Hex.TOP_LEFT_Y+(c+.5)*Hex.HEIGHT):(c=this._y/2,a=Hex.TOP_LEFT_X+Hex.EDGE_LENGTH*this._x*3,b=Hex.TOP_LEFT_Y+c*Hex.HEIGHT),[a,b]},"undefined"!=typeof module&&module.exports&&(module.exports=Hex),"undefined"!=typeof module&&module.exports)var Globals=require("../globals.js"),Dir=require("./dir.js"),Hex=require("./hex.js"),Country=require("./country.js");var Map=function(){this._hexArray=[],this._countryArray=[],this._adjacencyList={}};if(Map.prototype.clone=function(){var a=new Map;return a._hexArray=this._hexArray.map(function(a){return a.clone()}),a._countryArray=this._hexArray.map(function(a){return a.clone()}),a._adjacencyList=JSON.parse(JSON.stringify(this._adjacencyList)),a},Map.prototype.getHex=function(a){return 0>a||a>=this._hexArray.length?null:null===this._hexArray[a]?(Globals.debug("Nonexistant hex requested",a,Globals.LEVEL.WARN,Globals.CHANNEL.MAP),null):this._hexArray[a]},Map.prototype.countryHexes=function(a){var b=this.getCountry(a);return b?b.hexes():[]},Map.prototype.getCountry=function(a){return 0>a||a>=this._countryArray.length?null:null===this._countryArray[a]?(Globals.debug("Nonexistant country requested",a,Globals.LEVEL.WARN,Globals.CHANNEL.MAP),null):this._countryArray[a]},Map.prototype.countryCount=function(){return this._countryArray.length},Map.prototype.adjacentCountries=function(a){return this._adjacencyList[a]},Map.prototype.adjacencyList=function(){return this._adjacencyList},Map.prototype.serializeHexes=function(){return JSON.stringify(this._hexArray.filter(function(a){return a.countryId()>=0}))},Map.prototype.deserializeHexes=function(a){var b=this;b._countryArray=[],b._hexArray=[];var c={},d=JSON.parse(a),e={};d.forEach(function(a){a&&a.hasOwnProperty("_id")&&(e[a._id]=a)});for(var f=0;f<Hex.TOTAL_HEXES;f++){var g;if(e.hasOwnProperty(f)){var h=e[f];g=new Hex(h._id,h._x,h._y,h._countryId,h._countryEdgeDirections)}else g=new Hex(f);b._hexArray[f]=g,g.countryId()>=0&&(c[g.countryId()]||(c[g.countryId()]=new Country(g.countryId())),c[g.countryId()].hexes().push(g.id()))}b._countryArray.length=Object.keys(c).length,Object.keys(c).forEach(function(a){b._countryArray[a]=c[a]}),b._countryArray.forEach(function(a){b.setupCountryEdges(a)})},Map.prototype.getState=function(){var a=[];return this._countryArray.forEach(function(b){a.push(b.getState())}),a},Map.prototype.setState=function(a){var b=this;a.countryIds().forEach(function(c){b._countryArray[c].setState(a,c)})},Map.prototype.generateMap=function(a){for(var b=this,c=0;c<this._countryArray.length;c++)this._countryArray[c]._hexIds=[],delete this._countryArray[c];for(var c=0;c<this._hexArray.length;c++)delete this._hexArray[c];this._adjacencyList={},this._countryArray=[],this._hexArray=[];for(var c=0;c<Hex.TOTAL_HEXES;c++)this._hexArray.push(new Hex(c));Globals.debug("Created hexes ",JSON.stringify(this._hexArray),Globals.LEVEL.TRACE,Globals.CHANNEL.MAP),this.pruneEdges();var d=new Country(this._countryArray.length);this._countryArray.push(d);for(var e=null;!e||e._pruned;)e=this._hexArray[Math.floor(Math.random()*this._hexArray.length)];this.landGrab(e,d);for(var c=0;c<Globals.numCountries-1;c++){
for(var f,g=Math.floor(Math.random()*this._countryArray.length),h=0;h<this._countryArray.length;h++){var d=this._countryArray[(h+g)%this._countryArray.length];if(!d.isLake()&&(f=b.findAdjacentHex(d)))break}if(!f)return Globals.debug("RAN OUT OF SPACE! ",c,"recursing",Globals.LEVEL.WARN,Globals.CHANNEL.MAP),b.generateMap(a);var i=new Country(this._countryArray.length);this._countryArray.push(i),this.landGrab(f,i),i.isLake()&&c--}Globals.debug("Created countries ",JSON.stringify(this._countryArray),Globals.LEVEL.TRACE,Globals.CHANNEL.MAP),b._hexArray.forEach(function(a){if(!a.hasCountry()){for(var c=0;c<Dir.array.length;c++){var d=Dir.nextHex(a,Dir.array[c],b);if(!d||!d.hasCountry()||b.getCountry(d.countryId()).isLake())return}b.moveToAdjacentCountry(a)}}),this.pruneLakes(),Globals.debug("Map adjacency list: "+JSON.stringify(this._adjacencyList),Globals.LEVEL.TRACE,Globals.CHANNEL.MAP)},Map.prototype.pruneEdges=function(){var a=Hex.NUM_WIDE,b=Hex.NUM_HIGH;this.makeBlob(Math.floor(a/4+Math.random()*a/2),0,100+Math.floor(200*Math.random())),this.makeBlob(Math.floor(a/4+Math.random()*a/2),b-1,100+Math.floor(200*Math.random())),this.makeBlob(0,Math.floor(Math.random()*b),100+Math.floor(200*Math.random())),this.makeBlob(a-1,Math.floor(Math.random()*b),100+Math.floor(200*Math.random()))},Map.prototype.findAdjacentUnpruned=function(a){for(var b=this,c=Math.floor(Math.random()*a.length),d=0;d<a.length;d++)for(var e=a[(c+d)%a.length],f=Math.floor(Math.random()*Dir.array.length),g=0;g<Dir.array.length;g++){var h=Dir.array[(f+g)%Dir.array.length],i=Dir.nextHex(e,h,b);if(i&&!i._pruned)return i}return null},Map.prototype.makeBlob=function(a,b,c){var d=this,e=[],f=Hex.NUM_WIDE/2,g=Hex.NUM_HIGH/2,h={};e.push(d._hexArray[b*Hex.NUM_WIDE+a]),e[0]._pruned=!0,h[e[0].id()]=!0;for(var i=1,j=0;c>i&&2*c>j;){j++;var k=d.findAdjacentUnpruned(e);if(k&&!(g>b&&k.y()>=g||b>=g&&k.y()<=g||f>a&&k.x()>=f||a>=f&&k.x()<=f)){for(var l=!1,m=0;m<Dir.array.length;m++){var n=Dir.nextHex(k,Dir.array[m],d);if(n&&n._pruned&&!h[n.id()]){l=!0;break}}l||(i++,k._pruned=!0,h[k.id()]=!0,e.push(k))}}},Map.prototype.oldpruneEdges=function(){for(var a=this,b={TOP:0,RIGHT:1,BOTTOM:2,LEFT:3},c=0;1200>c;){var d=b.BOTTOM,e=0,f=0,g=0;if(d==b.TOP){for(f=0,e=Math.floor(Math.random()*Hex.NUM_WIDE),g=f*Hex.NUM_WIDE+e;a._hexArray[g]._pruned&&f<Hex.NUM_HIGH/2;)f++,g=f*Hex.NUM_WIDE+e;f<Hex.NUM_HIGH/2&&(a._hexArray[g]._pruned=!0,c++)}else if(d==b.RIGHT){for(e=Hex.NUM_WIDE-1,f=Math.floor(Math.random()*Hex.NUM_HIGH),g=f*Hex.NUM_WIDE+e;a._hexArray[g]._pruned&&e>Hex.NUM_WIDE/2;)e--,g=f*Hex.NUM_WIDE+e;e>Hex.NUM_WIDE/2&&(a._hexArray[g]._pruned=!0,c++)}else if(d==b.BOTTOM){for(f=Hex.NUM_HIGH-1,e=Math.floor(Math.random()*Hex.NUM_WIDE),g=f*Hex.NUM_WIDE+e;a._hexArray[g]._pruned&&f>Hex.NUM_HIGH/2;)f--,g=f*Hex.NUM_WIDE+e;f>Hex.NUM_HIGH/2&&(a._hexArray[g]._pruned=!0,c++)}else if(d==b.LEFT){for(e=0,f=Math.floor(Math.random()*Hex.NUM_HIGH),g=f*Hex.NUM_WIDE+e;a._hexArray[g]._pruned&&e<Hex.NUM_WIDE/2;)e++,g=f*Hex.NUM_WIDE+e;e<Hex.NUM_WIDE/2&&(a._hexArray[g]._pruned=!0,c++)}}},Map.prototype.validate=function(){var a=this;a._countryArray.forEach(function(b,c){Globals.ASSERT(b.id()==c);var d=b.hexes();Globals.ASSERT(d.length),d.forEach(function(c){Globals.ASSERT(a._hexArray[c]),a._hexArray[c].countryId()!==b.id()&&console.log("HexId "+c+" assigned to country "+a._hexArray[c].countryId()+" should be assigned to "+b.id())})})},Map.prototype.isConnected=function(a,b){for(var c=0;c<this._adjacencyList[a].length;c++)if(this._adjacencyList[a][c]==b)return!0;return!1},Map.prototype.pruneLakes=function(){var a=this;this._countryArray=this._countryArray.filter(function(b){return b.isLake()?(b.hexes().forEach(function(b){var c=a.getHex(b);c.setCountry(null),c.setCountryEdgeDirections(null)}),!1):!0}),this._countryArray=this._countryArray.map(function(b,c){return a.setCountryId(c,b),b})},Map.prototype.assignCountries=function(a){var b=this,c=Globals.shuffleArray(this._countryArray),d=0;c.forEach(function(c){a[d].addCountry(c),b.setupCountryEdges(c),d++,d>=a.length&&(d=0)})},Map.prototype.setupCountryEdges=function(a){var b=this,c={};b._adjacencyList[a.id()]=[],a.hexes().forEach(function(d){for(var e=b.getHex(d),f=[],g=0;g<Dir.array.length;g++){var h=Dir.nextHex(e,g,b);h&&h.countryId()==a.id()||f.push(g),h&&h.countryId()>=0&&h.countryId()!=a.id()&&!c[h.countryId()]&&(Globals.ASSERT(h.countryId()>=0),c[h.countryId()]=!0,b._adjacencyList[a.id()].push(h.countryId()))}e.setCountryEdgeDirections(f)})},Map.prototype.moveToAdjacentCountry=function(a){for(var b=this,c=0;c<Dir.array.length;c++){var d=Dir.nextHex(a,c,b);if(d&&d.hasCountry()&&!b.getCountry(d.countryId()).isLake()){var e=b.getCountry(d.countryId());return a.setCountry(e),Globals.ASSERT(b.getCountry(e.id())),void e.hexes().push(a.id())}}Globals.debug("Can't find an adjacent country",Globals.LEVEL.ERROR,Globals.CHANNEL.MAP)},Map.prototype.countryCenter=function(a){var b=this,c=[0,0],d=this.countryHexes(a);return d.forEach(function(a){var d=b.getHex(a),e=d.center();c[0]+=e[0],c[1]+=e[1]}),c[0]/=d.length,c[1]/=d.length,c},Map.prototype.fromMousePos=function(a,b){var c=this,d=a,e=b;b-=Hex.TOP_LEFT_Y;var f=Hex.NUM_HIGH*Hex.HEIGHT;Math.floor(b/f*(2*Hex.NUM_HIGH));a-=Hex.TOP_LEFT_X;var g=Hex.NUM_WIDE*(3*Hex.EDGE_LENGTH);if(a>=g)return null;var h=(Math.floor(a/g*(6*Hex.NUM_WIDE)),Math.floor((a-Hex.EDGE_LENGTH/2)/g*Hex.NUM_WIDE)),i=Math.floor((b-Hex.HEIGHT/2)/f*Hex.NUM_HIGH),j=i*(2*Hex.NUM_WIDE)+h,k=j+1,l=j+2*Hex.NUM_WIDE,m=l+1,n=j+Hex.NUM_WIDE,o=n-2*Hex.NUM_WIDE,p=n+2*Hex.NUM_WIDE,q=[j,k,l,m,n,o,p],r=1/0,s=null;return q.forEach(function(a){if(a>=0&&a<Hex.TOTAL_HEXES){var b=c.getHex(a),f=b.center(),g=Math.pow(f[0]-d,2)+Math.pow(f[1]-e,2);r>g&&(r=g,s=b)}}),s},Map.prototype.findAdjacentHex=function(a){for(var b=this,c=0;c<a._hexIds.length;c++)for(var d=Math.floor(Math.random()*a._hexIds.length),e=0;e<Dir.array.length;e++){var f=Dir.array[Math.floor(Math.random()*Dir.array.length)],g=Dir.nextHex(b.getHex(a._hexIds[d]),f,b);if(g&&-1==g.countryId()&&!g._pruned)return g}return null},Map.prototype.growCountry=function(a){var b=this;if(!(a._hexIds.length>=a._numHexes)){var c=b.findAdjacentHex(a);if(!c)return void Globals.debug("Couldn't find a new spot for a hex!",Globals.LEVEL.TRACE,Globals.CHANNEL.COUNTRY);c.setCountry(a),Globals.ASSERT(b.getCountry(a.id())),a._hexIds.push(c.id()),Globals.debug("growCountry",a,c,Globals.LEVEL.TRACE,Globals.CHANNEL.COUNTRY),b.growCountry(a)}},Map.prototype.landGrab=function(a,b){var c=this;return b._hexIds=[a.id()],a.setCountry(b),Globals.ASSERT(c.getCountry(b.id())),b._numHexes=Math.floor(Math.random()*(Country.MAX_HEXES-Country.MIN_HEXES+1))+Country.MIN_HEXES,c.growCountry(b),b._numHexes!=b._hexIds.length&&(b._isLake=!0,b._hexIds.length<=5)?void c.absorbLake(b):void 0},Map.prototype.absorbLake=function(a){var b=this;a._hexIds.forEach(function(a){b.moveToAdjacentCountry(b.getHex(a))}),a._hexIds=[]},Map.prototype.setCountryId=function(a,b){Globals.debug("Changine country id from "+b._id+" to "+a,b,Globals.LEVEL.TRACE,Globals.CHANNEL.COUNTRY);var c=this;b._id=a,c.getCountry(a)!=b&&Globals.debug("Country id set to value which doesn't match Map array",b,Globals.LEVEL.WARN,Globals.CHANNEL.COUNTRY),b._hexIds.forEach(function(a){c.getHex(a).setCountry(b),Globals.ASSERT(c.getCountry(b.id()))})},"undefined"!=typeof module&&module.exports&&(module.exports=Map),"undefined"!=typeof module&&module.exports)var Globals=require("../globals.js"),Country=require("./country.js");var PENALTY_TIMEOUT=100,Player=function(a,b){this._id=a,this._engine=b,this._countries=[],this._storedDice=0,this._numContiguousCountries=0,this._timeBudget=-1,this._timerId=-1,this._inPenalty=!1,this._turnCount=0,this._totalTime=0};Player.rollDie=function(){return Math.floor(6*Math.random())+1},Player.rollDice=function(a){for(var b=[],c=0;a>c;c++)b.push(Player.rollDie());return b},Player.prototype.id=function(){return this._id},Player.prototype.hasLost=function(){return 0==this._countries.length},Player.prototype.storedDice=function(){return this._storedDice},Player.prototype.removeStoredDie=function(){this._storedDice&&this._storedDice--},Player.prototype.countries=function(){return this._countries},Player.prototype.countryCount=function(){return this._countries.length},Player.prototype.numContiguousCountries=function(){return this._numContiguousCountries},Player.prototype.turnStarted=function(){},Player.prototype.turnEnded=function(){this._turnCount++,this._totalTime-=this._timeBudget},Player.prototype.timePerTurn=function(){return this._turnCount?Math.round(this._totalTime/this._turnCount):0},Player.prototype.setTimeBudget=function(a){var b=this;b._timeBudget=a,this._totalTime+=a,b._inPenalty=!1,b._timerId>=0&&(b._cancelTimer(b._timerId),b._timerId=-1),Globals.debug("setTimeBudget",b._timeBudget,Globals.LEVEL.DEBUG,Globals.CHANNEL.PLAYER)},Player.prototype.startClock=function(){var a=this;-1==a._timerId?(a._timerId=a._setTimer(a.timeout.bind(a),a._timeBudget),a._mark=Date.now(),Globals.debug("startClock playerId=",a._id,a._timeBudget,Globals.LEVEL.DEBUG,Globals.CHANNEL.PLAYER)):Globals.debug("starClock called with no timerId >= 0",Globals.LEVEL.WARN,Globals.CHANNEL.PLAYER)},Player.prototype.stopClock=function(){var a=this;a._timerId>=0?(a._cancelTimer(a._timerId),a._timeBudget-=Math.max(Date.now()-a._mark,0),a._timerId=-1,Globals.debug("stopClock playerId=",a._id,a._timeBudget,Globals.LEVEL.DEBUG,Globals.CHANNEL.PLAYER)):Globals.debug("stopClock called with timerId=-1",Globals.LEVEL.WARN,Globals.CHANNEL.PLAYER)},Player.prototype.timeout=function(){var a=this;a._timerId=-1,Globals.timePenalties?(a._timeBudget=PENALTY_TIMEOUT,a._totalTime+=PENALTY_TIMEOUT,a.startClock(),a._inPenalty?a.penalize():(Globals.debug("Player",a._id,"entering penalty",Globals.LEVEL.INFO,Globals.CHANNEL.PLAYER),a._inPenalty=!0)):a.penalize()},Player.prototype.penalize=function(){var a=this;a._engine&&a._engine.penalizePlayer(a._id)},Player.prototype.addCountry=function(a){a.setOwner(this.id()),this._countries.push(a.id()),Globals.debug("Player "+this._id+" added country "+a.id(),Globals.LEVEL.TRACE,Globals.CHANNEL.PLAYER),Globals.debug("New country count: "+this._countries.length,Globals.LEVEL.TRACE,Globals.CHANNEL.PLAYER)},Player.prototype.loseCountry=function(a){var b=this;Globals.debug("Player "+b._id+" lost country "+a.id(),Globals.LEVEL.DEBUG,Globals.CHANNEL.PLAYER),this._countries=this._countries.filter(function(b){return b!=a.id()})},Player.prototype.countriesWithSpace=function(a){return this._countries.filter(function(b){return a.getCountry(b).numDice()<Globals.maxDice}).map(function(b){return a.getCountry(b)})},Player.prototype.updateStatus=function(a){var b=this;if(!this.hasLost()){var c={},d=0,e=function(d){return c[d.id()]?0:(c[d.id()]=!0,1+a.adjacentCountries(d.id()).reduce(function(c,d){var f=a.getCountry(d);return Globals.ASSERT(f),f.ownerId()==b.id()&&(c+=e(f)),c},0))};this._countries.forEach(function(b){var c=e(a.getCountry(b));c>d&&(d=c)}),this._numContiguousCountries=d}},Player.prototype._setTimer=function(a,b){return"undefined"!=typeof module&&module.exports?setTimeout(a,b):window.setTimeout(a,b)},Player.prototype._cancelTimer=function(a){return"undefined"!=typeof module&&module.exports?clearTimeout(a):window.clearTimeout(a)},"undefined"!=typeof module&&module.exports&&(module.exports=Player);var logBuffer=[],BUFFER_LENGTH=100,uploadFn=null,GAME_ID="",redirectFn=null,Globals={initLogger:function(a,b){GAME_ID=a,uploadFn=b},setLogRedirect:function(a){redirectFn=a},debug:function(a){if(redirectFn)redirectFn.apply(null,arguments);else{var b=arguments.length,c="",d=b-1;"string"==typeof arguments[d]?(d=b-1,c=arguments[d]):(d=b,c=GAME_ID);var e=d-1,f=e-1;if(f>=1&&"number"==typeof arguments[e]&&"number"==typeof arguments[f]&&arguments[e]<Globals.channelNames.length){var g=arguments[e],h=arguments[f],i="",j=arguments;Object.keys(arguments).forEach(function(a,b){f>b&&(i+=j[a]+" ")}),h<Globals.errorReportLevels[g]&&(logBuffer.unshift({channel:g,level:h,gameId:GAME_ID,msg:i.substring(0,150)}),logBuffer.length>BUFFER_LENGTH&&logBuffer.pop(),uploadFn&&h==Globals.LEVEL.ERROR&&uploadFn(GAME_ID,logBuffer)),h<=Globals.channels[g]&&console.log(i)}else console.log(a,arguments)}},ASSERT:function(a){if(!a){console.log("ASSERTION FAILURE");try{var b=new Error("assertion");console.log(b.stack)}catch(c){}throw new Error("Assertion Failure")}},showNumbers:!1,showCountryIds:!1,markHexCenters:!1,markCountryCenters:!1,drawCountryConnections:!1,maxPlayers:8,maxDice:8,maxStoredDice:64,startingDice:10,numCountries:32,timeout:150,play_sounds:0,suppress_ui:0,uploadGame:!1,timePenalties:!1};Globals.LEVEL={NONE:0,ERROR:1,WARN:2,INFO:3,DEBUG:4,TRACE:5},Globals.levelNames=[],Object.keys(Globals.LEVEL).forEach(function(a,b){Globals.levelNames[b]=a}),Globals.CHANNEL={ENGINE:0,MAP:1,HEX:2,COUNTRY:3,PLAYER:4,PLYER:5,RENDERER:6,GREEDY:7,CLIENT:8,CLIENT_SOCKET:9,AI_WRAPPER:10,MAP_CONTROLLER:11,DOWNLOADER:12,SERVER:13,SERVER_SOCKET:14,USER_AI:15,GAME:16,ADMIN:17,RATER:18,DEFAULT:19},Globals.channelNames=[],Object.keys(Globals.CHANNEL).forEach(function(a,b){Globals.channelNames[b]=a}),Globals.channels=[],Globals.channels.length=Object.keys(Globals.CHANNEL).length,Globals.channels[Globals.CHANNEL.ENGINE]=Globals.LEVEL.WARN,Globals.channels[Globals.CHANNEL.MAP]=Globals.LEVEL.WARN,Globals.channels[Globals.CHANNEL.HEX]=Globals.LEVEL.WARN,Globals.channels[Globals.CHANNEL.COUNTRY]=Globals.LEVEL.WARN,Globals.channels[Globals.CHANNEL.PLAYER]=Globals.LEVEL.WARN,Globals.channels[Globals.CHANNEL.PLYER]=Globals.LEVEL.WARN,Globals.channels[Globals.CHANNEL.RENDERER]=Globals.LEVEL.WARN,Globals.channels[Globals.CHANNEL.GREEDY]=Globals.LEVEL.WARN,Globals.channels[Globals.CHANNEL.CLIENT]=Globals.LEVEL.INFO,Globals.channels[Globals.CHANNEL.CLIENT_SOCKET]=Globals.LEVEL.INFO,Globals.channels[Globals.CHANNEL.AI_WRAPPER]=Globals.LEVEL.INFO,Globals.channels[Globals.CHANNEL.MAP_CONTROLLER]=Globals.LEVEL.WARN,Globals.channels[Globals.CHANNEL.DOWNLOADER]=Globals.LEVEL.WARN,Globals.errorReportLevels=[],Globals.errorReportLevels.length=Object.keys(Globals.CHANNEL).length,Globals.errorReportLevels[Globals.CHANNEL.ENGINE]=Globals.LEVEL.DEBUG,Globals.errorReportLevels[Globals.CHANNEL.MAP]=Globals.LEVEL.DEBUG,Globals.errorReportLevels[Globals.CHANNEL.HEX]=Globals.LEVEL.DEBUG,Globals.errorReportLevels[Globals.CHANNEL.COUNTRY]=Globals.LEVEL.DEBUG,Globals.errorReportLevels[Globals.CHANNEL.PLAYER]=Globals.LEVEL.DEBUG,Globals.errorReportLevels[Globals.CHANNEL.PLYER]=Globals.LEVEL.WARN,Globals.errorReportLevels[Globals.CHANNEL.RENDERER]=Globals.LEVEL.WARN,Globals.errorReportLevels[Globals.CHANNEL.GREEDY]=Globals.LEVEL.WARN,Globals.errorReportLevels[Globals.CHANNEL.CLIENT]=Globals.LEVEL.TRACE,Globals.errorReportLevels[Globals.CHANNEL.CLIENT_SOCKET]=Globals.LEVEL.TRACE,Globals.errorReportLevels[Globals.CHANNEL.AI_WRAPPER]=Globals.LEVEL.TRACE,Globals.errorReportLevels[Globals.CHANNEL.MAP_CONTROLLER]=Globals.LEVEL.INFO,Globals.errorReportLevels[Globals.CHANNEL.DOWNLOADER]=Globals.LEVEL.DEBUG,Globals.shuffleArray=function(a){for(var b,c,d=a.map(function(a){return a}),e=d.length;e>0;)c=Math.floor(Math.random()*e),e--,b=d[e],d[e]=d[c],d[c]=b;return d},Globals["implements"]=function(a,b){for(var c in b)if("function"==typeof b[c]&&(!a.hasOwnProperty(c)&&!a.__proto__.hasOwnProperty(c)||"function"!=typeof a[c]))return!1;return!0},Globals.indexOfMax=function(a){for(var b=a[0],c=0,d=1;d<a.length;d++)a[d]>b&&(c=d,b=a[d]);return c},"undefined"!=typeof module&&module.exports&&(module.exports=Globals),function(a){a.extend({playSound:function(){return a("<embed src='"+arguments[0]+".mp3' hidden='true' autostart='true' loop='false' class='playSound'><audio autoplay='autoplay' style='display:none;' controls='controls'><source src='"+arguments[0]+".mp3' /><source src='"+arguments[0]+".ogg' /></audio>").appendTo("body")}})}(jQuery);var Message={TYPE:{PLAYER_STATUS:"player_status",PLAYER_INITIALIZED:"player_initialized",STATE:"state_update",CREATE_BOT:"create_bot",CREATE_HUMAN:"create_human",START_TURN:"start_turn",ATTACK_RESULT:"attack_result",TURN_ENDED:"turn_ended",ATTACK:"attack",END_TURN:"end_turn"},playerStatus:function(a,b,c){return{playerId:a,connected:b,playerName:c}},playerInitialized:function(){return{}},createBot:function(a,b){return{name:a,playerId:b}},createHuman:function(a,b){return{name:a,playerId:b}},state:function(a,b){return{stateId:a,gameId:b}},startTurn:function(a,b){return{playerId:a,stateId:b}},attackResult:function(a,b,c){return{playerId:a,success:b,stateId:c}},attack:function(a,b,c){return{playerId:c,from:a,to:b}},endTurn:function(a){return{playerId:a}},turnEnded:function(a,b){return{playerId:a,stateId:b}}};"undefined"!=typeof module&&module.exports&&(module.exports=Message);var log=null,CHANNEL;if("undefined"!=typeof module&&module.exports){var Globals=require("../globals.js"),logger=require("../../../lib/logger.js"),Message=require("./message");log=logger.log,CHANNEL=logger.CHANNEL.SERVER_SOCKET}else log=Globals.debug,CHANNEL=Globals.CHANNEL.CLIENT_SOCKET;var SocketWrapper=function(a,b){this._socket=a,this._gameId=b,this._id=a.id,this._callbacks={}};SocketWrapper.prototype.id=function(){return this._id},SocketWrapper.prototype.ip=function(){return this._socket?this._socket.handshake.address:void 0},SocketWrapper.prototype.on=function(a,b,c){var d=this;d._callbacks.hasOwnProperty(a)?d._callbacks[a].push({fn:b,context:c}):(d._callbacks[a]=[{fn:b,context:c}],d._socket.on(a,function(){log("=>",a,JSON.stringify(arguments),Globals.LEVEL.INFO,CHANNEL,d._gameId);var b=[];b.push(d);for(var c=Object.keys(arguments).length,e=0;c>e;e++)b.push(arguments[e]);d._callbacks[a].forEach(function(a){a.fn.apply(a.context,b)})}))},SocketWrapper.prototype._emit=function(a,b){log("<=",a,JSON.stringify(b),Globals.LEVEL.INFO,CHANNEL,this._gameId),this._socket.emit(a,b)},SocketWrapper.prototype.removeAll=function(){var a=this;a._socket&&Object.keys(a._callbacks).forEach(function(b){a._socket.removeAllListeners(b)}),a._callbacks={}},SocketWrapper.prototype.removeAllListeners=function(a){this._socket&&this._socket.removeAllListeners(a),delete this._callbacks[a]},SocketWrapper.prototype.removeListener=function(a,b,c){var d=this,e=d._callbacks[a];e&&e.forEach(function(e,f){b==e.fn&&c==e.context&&d._callbacks[a].splice(f,1)})},SocketWrapper.prototype.disconnect=function(){var a=this;this._callbacks={},a._socket&&(a._socket.disconnect(),delete a._socket,a._socket=null)},SocketWrapper.prototype.sendPlayerStatus=function(a,b,c){this._emit(Message.TYPE.PLAYER_STATUS,Message.playerStatus(a,b,c))},SocketWrapper.prototype.sendPlayerInitialized=function(a){this._emit(Message.TYPE.PLAYER_INITIALIZED,Message.playerInitialized(a))},SocketWrapper.prototype.sendCreateBot=function(a,b){this._emit(Message.TYPE.CREATE_BOT,Message.createBot(a,b))},SocketWrapper.prototype.sendCreateHuman=function(a,b){this._emit(Message.TYPE.CREATE_HUMAN,Message.createHuman(a,b))},SocketWrapper.prototype.sendState=function(a,b){this._emit(Message.TYPE.STATE,Message.state(a,b))},SocketWrapper.prototype.sendStartTurn=function(a,b){this._emit(Message.TYPE.START_TURN,Message.startTurn(a,b))},SocketWrapper.prototype.sendAttack=function(a,b,c){this._emit(Message.TYPE.ATTACK,Message.attack(a,b,c))},SocketWrapper.prototype.sendAttackResult=function(a,b,c){this._emit(Message.TYPE.ATTACK_RESULT,Message.attackResult(a,b,c))},SocketWrapper.prototype.sendEndTurn=function(a){this._emit(Message.TYPE.END_TURN,Message.endTurn(a))},SocketWrapper.prototype.sendTurnEnded=function(a,b){this._emit(Message.TYPE.TURN_ENDED,Message.turnEnded(a,b))},"undefined"!=typeof module&&module.exports&&(module.exports=SocketWrapper);var ANIMATE=!0,DRAW_DICE=!0,SKY=!0,SHADOW=!1,DRAW_BORDERS=!0,GLrenderer={X:0,Y:1,Z:2,_context:null,_initialized:!1,_highlightedCountry:-1,_selectedCountry:-1,_mouseOverCountry:-1,_names:[],_map:null,_playerColors:[16711680,255,65280,16776960,16748544,9437328,8405040,11571328],_mapCenterX:0,_mapCenterY:0,_angleY:0,_angleX:0,_angleZ:Math.PI/2,_theta:Math.PI/4,_elevation:35,_radius:75,_mouseDown:!1,_lastMouseX:-1,_lastMouseY:-1,_lastRenderTime:-1,_diceGraph:[],_cylinders:{},_dice:{},_canvasHeight:0,_canvasWidth:0,_mouseVector:null,_raycaster:null,_listener:null,init:function(a,b,d,e){var f=this;Globals.ASSERT(Globals["implements"](e,Renderer.iface)),this._listener=e,this._mouseVector=new THREE.Vector2,this._raycaster=new THREE.Raycaster,this._map=b,this._names=d||[],this._initialized=!0;var g=-1,h=1e4,i=1e4,j=-1;b._hexArray.forEach(function(a){var b=a.upperLeft();g=Math.max(g,b[0]),h=Math.min(h,b[0]),j=Math.max(j,b[1]),i=Math.min(i,b[1])}),f._mapCenterX=(g-h)/(2*Hex.EDGE_LENGTH),f._mapCenterY=(j-i)/(2*Hex.EDGE_LENGTH),this._scene=new THREE.Scene,this._camera=new THREE.PerspectiveCamera(75,c.width/c.height,1,1e3),this._camera.up=new THREE.Vector3(0,0,1);var k=f._radius*Math.cos(f._theta);f._camera.position.z=f._radius*Math.sin(f._theta),f._camera.position.y=k*Math.sin(f._angleZ),f._camera.position.x=k*Math.cos(f._angleZ),f._camera.position.y+=f._mapCenterY,f._camera.position.x+=f._mapCenterX,this._camera.lookAt(new THREE.Vector3(f._mapCenterX,f._mapCenterY,0));var l=new THREE.AmbientLight(0);this._scene.add(l);var m=[];m[0]=new THREE.SpotLight(16777215,1,0),m[1]=new THREE.SpotLight(16777215,1,0),m[2]=new THREE.SpotLight(16777215,1,0),m[3]=new THREE.SpotLight(16777215,1,0),m[0].position.set(-200,200,100),m[1].position.set(200,200,100),m[2].position.set(-200,-200,100),m[3].position.set(-200,200,100),SHADOW&&(m[1].castShadow=!0,m[1].shadowDarkness=1),this._scene.add(m[0]),this._scene.add(m[1]),this._scene.add(m[2]),this._renderer=new THREE.WebGLRenderer({antialias:!0}),SHADOW&&(this._renderer.shadowMap.enabled=!0),this._renderer.setSize(c.width,c.height),$("#canvas3d_div").append(this._renderer.domElement),$(this._renderer.domElement).on("mousedown",GLrenderer.mouseDown.bind(this)),$(this._renderer.domElement).on("mouseup",GLrenderer.mouseUp.bind(this)),$(this._renderer.domElement).on("mousemove",GLrenderer.mouseMove.bind(this)),$(this._renderer.domElement).on("mouseleave",GLrenderer.mouseLeave.bind(this)),$(document).keydown(GLrenderer.keyDown.bind(this));var a=$(this._renderer.domElement);this._canvasWidth=a.width(),this._canvasHeight=a.height(),DRAW_DICE&&(this._texture=(new THREE.TextureLoader).load("/public/images/dice6-red.png",function(){f.update()})),SKY&&(new THREE.CubeTextureLoader).load(["/public/images/sky.jpg","/public/images/sky.jpg","/public/images/sky.jpg","/public/images/sky.jpg","/public/images/sky.jpg","/public/images/sky.jpg"],function(a){var b=THREE.ShaderLib.cube;b.uniforms.tCube.value=a;var c=new THREE.ShaderMaterial({fragmentShader:b.fragmentShader,vertexShader:b.vertexShader,uniforms:b.uniforms,depthWrite:!1,side:THREE.BackSide}),d=new THREE.Mesh(new THREE.CubeGeometry(1e3,1e3,1e3),c);f._scene.add(d),f.update()})},setMouseOverCountry:function(a){if(!this._isRendering){Globals.debug("setMouseOverCountry",a,Globals.LEVEL.TRACE,Globals.CHANNEL.RENDERER);var b=this._highlightedCountry;this._highlightedCountry=a,-1!=b&&this._drawCountry(b,this._lastRenderedState,!1),-1!=a&&this._drawCountry(a,this._lastRenderedState,!1),this.update()}},setSelectedCountry:function(a){if(!this._isRendering){Globals.debug("setSelectedCountry",a,Globals.LEVEL.TRACE,Globals.CHANNEL.RENDERER);var b=this._selectedCountry;this._selectedCountry=a,-1!=b&&this._drawCountry(b,this._lastRenderedState,!1),-1!=a&&this._drawCountry(a,this._lastRenderedState,!1),this.update()}},setPlayerName:function(a,b){},render:function(a,b){var c=this;return!a||c._isRendering?void Globals.debug("previous state rendering, render aborted",Globals.LEVEL.DEBUG,Globals.CHANNEL.RENDERER):(c._isRendering=!0,Globals.debug("render()",a.stateId(),Globals.LEVEL.TRACE,Globals.CHANNEL.RENDERER),Globals.ASSERT(a instanceof Gamestate),void(a.attack()?this._renderAttack(a).then(function(){c.update(),c._lastRenderedState=a,c._lastRenderTime=Date.now(),c._isRendering=!1,b&&b(a,a.stateId())}):this._drawMap(a,b).then(function(){c.update(),c._lastRenderedState=a,c._lastRenderTime=Date.now(),c._isRendering=!1,b&&b(a,a.stateId())})))},_renderAttack:function(a){if(!Globals.suppress_ui&&this._initialized&&a){var b=this;return new Promise(function(c){function d(a){Globals.debug("render defender",Globals.LEVEL.INFO,Globals.CHANNEL.RENDERER),b._drawCountry(h,a,!0),b.update(),window.setTimeout(function(){e(a)},k)}function e(a){Globals.debug("render defense roll",Globals.LEVEL.INFO,Globals.CHANNEL.RENDERER),window.setTimeout(function(){f(a)},k)}function f(a){Globals.debug("render verdict",Globals.LEVEL.INFO,Globals.CHANNEL.RENDERER),i>j?Globals.play_sounds&&$.playSound("/sounds/clink_sound"):Globals.play_sounds&&$.playSound("/sounds/wood_hit_brick_1"),c()}Globals.debug("renderAttack",Globals.LEVEL.INFO,Globals.CHANNEL.RENDERER);var g=a.attack().fromCountryId,h=(a.countryOwner(g),a.attack().toCountryId),i=(a.attack().fromRollArray.length,a.attack().toRollArray.length,a.attack().fromRollArray.reduce(function(a,b){return a+b},0)),j=a.attack().toRollArray.reduce(function(a,b){return a+b},0);Globals.debug("render attacker",Globals.LEVEL.INFO,Globals.CHANNEL.RENDERER),b._drawCountry(g,a,!0),b.update(),Globals.play_sounds&&$.playSound("/sounds/2_dice_throw_on_table");var k=Globals.timeout;window.setTimeout(function(){d(a)},k)})}},_drawMap:function(a){if(!Globals.suppress_ui&&this._initialized){Globals.debug("drawMap",Globals.LEVEL.DEBUG,Globals.CHANNEL.RENDERER),Globals.ASSERT(a instanceof Gamestate);var b=this;return Promise.mapSeries(a.countryIds(),function(c){return b._animateCountry(c,a)})}},_animateCountry:function(a,b){var c=this,d=b.countryDice(a),e=c._lastRenderedState?c._lastRenderedState.countryDice(a):d;if(Globals.debug("animateCountry",a,"from",e,"to",d,Globals.LEVEL.TRACE,Globals.CHANNEL.RENDERER),!ANIMATE||e==d||DRAW_DICE&&(b.attack()||c._lastRenderedState.attack()))return c._drawCountry(a,b,!1);Globals.debug("animating",d,Globals.LEVEL.TRACE,Globals.CHANNEL.RENDERER);var f=d>e?.5:-.5;return DRAW_DICE&&(f=d>e?1:-1),b.setCountryDice(a,e),new Promise(function(e){var g=function(){b.countryDice(a)!=d?(b.setCountryDice(a,b.countryDice(a)+f),c._drawCountry(a,b,!1),c.update(),requestAnimationFrame(g)):(b.setCountryDice(a,d),c._drawCountry(a,b,!1),e())};requestAnimationFrame(g)})},_drawCountry:function(a,b,c){if(!Globals.suppress_ui&&this._initialized){var d=this;c=c||!1,d.stateHash.hasCountryChanged(a,c,b.countryHash(a))&&(Globals.debug("drawCountry "+a,Globals.LEVEL.TRACE,Globals.CHANNEL.RENDERER),d._map.countryHexes(a).forEach(function(a){d._drawHex(d._map.getHex(a),b,c)}),DRAW_DICE&&d._drawDice(a,b))}},_drawHex:function(a,b,c){var d,e=this,f=a.countryId(),g=a.upperLeft();if(!e._hexGeometry&&DRAW_DICE&&(e._hexGeometry=new THREE.CylinderGeometry(1,1,1,6)),e._cylinders[a.id()])d=e._cylinders[a.id()],d.material.color=e._getCountryColor(f,b,c),DRAW_DICE||d.geometry.height==4*b.countryDice(f)||(e._scene.remove(d),d.geometry.dispose(),d.geometry=null,d.geometry=new THREE.CylinderGeometry(1,1,4*b.countryDice(f),6),SHADOW&&(d.receiveShadow=!0),e._scene.add(d));else{var h=e._playerColors[b.countryOwner(f)],i=DRAW_DICE?e._hexGeometry:new THREE.CylinderGeometry(1,1,4*b.countryDice(f),6),j=new THREE.MeshPhongMaterial({color:h,specular:1118481,shininess:30,shading:THREE.FlatShading});d=new THREE.Mesh(i,j),d.rotation.x=Math.PI/2,d.rotation.y=Math.PI/6,d.position.x=g[0]/Hex.EDGE_LENGTH,d.position.y=g[1]/Hex.EDGE_LENGTH,d.userData.hexId=a.id(),SHADOW&&(d.receiveShadow=!0),e._scene.add(d),e._cylinders[a.id()]=d,e._drawBorder(a,d)}},_drawBorder:function(a,b){if(DRAW_BORDERS){var c=this;a._countryEdgeDirections.length&&(b.updateMatrixWorld(),c._lineMaterial||(c._lineMaterial=new THREE.LineBasicMaterial({color:0})),a._countryEdgeDirections.forEach(function(d){var e=Dir.nextHex(a,d,c._map);if(e&&e.hasCountry()){var f=new THREE.Geometry;if(d==Dir.obj.NE){var g=b.geometry.vertices[0].clone();b.localToWorld(g),f.vertices.push(g),g=b.geometry.vertices[1].clone(),b.localToWorld(g),f.vertices.push(g)}if(d==Dir.obj.SE){var g=b.geometry.vertices[1].clone();b.localToWorld(g),f.vertices.push(g),g=b.geometry.vertices[2].clone(),b.localToWorld(g),f.vertices.push(g)}if(d==Dir.obj.S){var g=b.geometry.vertices[2].clone();b.localToWorld(g),f.vertices.push(g),g=b.geometry.vertices[3].clone(),b.localToWorld(g),f.vertices.push(g)}if(d==Dir.obj.SW){var g=b.geometry.vertices[3].clone();b.localToWorld(g),f.vertices.push(g),g=b.geometry.vertices[4].clone(),b.localToWorld(g),f.vertices.push(g)}if(d==Dir.obj.NW){var g=b.geometry.vertices[4].clone();b.localToWorld(g),f.vertices.push(g),g=b.geometry.vertices[5].clone(),b.localToWorld(g),f.vertices.push(g)}if(d==Dir.obj.N){var g=b.geometry.vertices[5].clone();b.localToWorld(g),f.vertices.push(g),g=b.geometry.vertices[0].clone(),b.localToWorld(g),f.vertices.push(g)}f.vertices.forEach(function(a){a.z+=.01});var h=new THREE.Line(f,c._lineMaterial);c._scene.add(h)}}))}},_getCountryColor:function(a,b,c){var d=this;c=c||!1;var e=new THREE.Color(d._playerColors[b.countryOwner(a)]);return c?e=new THREE.Color("rgb(50, 50, 50)"):a==d._highlightedCountry?e=a==d._selectedCountry?new THREE.Color("rgb(75, 75, 75)"):new THREE.Color("rgb(100, 100, 100)"):a==d._selectedCountry&&(e=new THREE.Color("rgb(50, 50, 50)")),e},_drawDice:function(a,b){var c=this;c._dice[a+":1"]||c._initializeDice(a);for(var d=1;9>d;d++)d<=b.countryDice(a)?c._dice[a+":"+d].visible=!0:c._dice[a+":"+d].visible=!1},_initializeDice:function(a){var b=this,c=2,d=b._map.countryCenter(a),e=d[0]/Hex.EDGE_LENGTH,f=d[1]/Hex.EDGE_LENGTH,g=c,h=0;if(b._diceGeometry||(b._diceGeometry=new THREE.BoxGeometry(c,c,c)),!b._diceMaterial){loader=new THREE.TextureLoader;var i=[new THREE.MeshBasicMaterial({map:loader.load("/public/images/dice1.png")}),new THREE.MeshBasicMaterial({map:loader.load("/public/images/dice2.png")}),new THREE.MeshBasicMaterial({map:loader.load("/public/images/dice3.png")}),new THREE.MeshBasicMaterial({map:loader.load("/public/images/dice4.png")}),new THREE.MeshBasicMaterial({map:loader.load("/public/images/dice5.png")}),new THREE.MeshBasicMaterial({map:loader.load("/public/images/dice6.png")})];b._diceMaterial=new THREE.MultiMaterial(i)}for(var j=1;9>j;j++){var k=new THREE.Mesh(b._diceGeometry,b._diceMaterial);k.position.x=e,k.position.y=f,k.position.z=g,k.rotation.z=h,SHADOW&&(k.castShadow=!0),b._dice[a+":"+j]=k,b._scene.add(k),g+=c,h+=Math.PI/10,4==j&&(g=2,h=0,f+=c+.1)}},mouseLeave:function(a){this._lastMouseX=-1,this._lastMouseY=-1,this._listener&&-1!=this._mouseOverCountry&&(this._mouseOverCountry=-1,this._listener.mouseOverCountry(-1))},mouseMove:function(a){var b=this;b._mouseVector.x=2*(a.offsetX/b._canvasWidth)-1,b._mouseVector.y=1-2*(a.offsetY/b._canvasHeight);var c=[];Object.keys(b._cylinders).forEach(function(a){c.push(b._cylinders[a])}),b._raycaster.setFromCamera(b._mouseVector,b._camera);var d=b._raycaster.intersectObjects(c),e=d[0],f=-1;if(e){var g=b._map.getHex(e.object.userData.hexId);g&&(f=g.countryId())}b._mouseOverCountry!=f&&(b._mouseOverCountry=f,b._listener&&(Globals.debug("detected mouse over country",f,Globals.LEVEL.TRACE,Globals.CHANNEL.RENDERER),b._listener.mouseOverCountry(f)))},mouseDown:function(){this._mouseDown=!0},mouseUp:function(){this._mouseDown=!1,this._lastMouseX=-1,this._lastMouseY=-1},keyDown:function(a){var b=this,c=!1;switch(a.which){case 37:case 65:b._angleZ-=.1,c=!0;break;case 38:case 87:b._theta+=.1,b._theta=Math.min(b._theta,Math.PI/2),c=!0;break;case 39:case 68:b._angleZ+=.1,c=!0;break;case 40:case 83:b._theta-=.1,b._theta=Math.max(b._theta,0),c=!0;break;case 81:b._radius-=5,b._radius=Math.max(b._radius,0),c=!0;break;case 90:b._radius+=5,c=!0}var d=b._radius*Math.cos(b._theta);return b._camera.position.z=b._radius*Math.sin(b._theta),b._camera.position.y=d*Math.sin(b._angleZ),b._camera.position.x=d*Math.cos(b._angleZ),b._camera.position.y+=b._mapCenterY,b._camera.position.x+=b._mapCenterX,b._camera.lookAt(new THREE.Vector3(b._mapCenterX,b._mapCenterY,0)),b.update(),
!c},update:function(){var a=this;Globals.debug("update()",Globals.LEVEL.DEBUG,Globals.CHANNEL.RENDERER),requestAnimationFrame(a.renderEngineCallback.bind(a))},renderEngineCallback:function(){var a=this;console.time("RenderTime"),a._renderer.render(a._scene,a._camera),console.timeEnd("RenderTime")},stateHash:{_players:{},_countries:{},reset:function(){this._players={},this._countries={}},hasPlayerChanged:function(a,b){return this._players[a]===b?!1:(this._players[a]=b,!0)},hasCountryChanged:function(a,b,c){return b&&(c+=1),a==GLrenderer._highlightedCountry&&(c+=2),a==GLrenderer._selectedCountry&&(c+=4),this._countries[a]===c?!1:(this._countries[a]=c,!0)}}};$(function(){window.PlayerStatus={_playerColors:["red","blue","green","yellow","orange","purple","brown","tan"],init:function(a){this._players=a,this._setupPlayerDivs(this._players.length)},setPlayerName:function(a,b){this._players[a]&&(this._players[a]=b)},_setupPlayerDivs:function(a){var b=this;$("#players").html("");for(var c=0;a>c;++c)$("#players").append("<div id='player"+c+"' class='col-sm-2 player-box'><div id='colorblock"+c+"' class='color-block'></div>"+(b._players&&b._players[c]?"<div id='name"+c+"' class='name-box'>"+b._players[c]+"</div>":"")+"<div id='dice"+c+"' class='dice-box'>1</div><div id='stored"+c+"' class='stored-box'>0</div></div>"),$("#colorblock"+c).css({"background-color":b._playerColors[c]}),$("#stored"+c).css({color:b._playerColors[c]})},renderPlayers:function(a){var b=this;a.playerIds().forEach(function(c){b._renderPlayer(c,a)})},_renderPlayer:function(a,b){Globals.debug("renderPlayer "+a,Globals.LEVEL.DEBUG,Globals.CHANNEL.RENDERER),Globals.ASSERT(b instanceof Gamestate),b.playerHasLost(a)?$("#player"+a).hide():($("#player"+a).show(),a==b.currentPlayerId()?$("#player"+a).addClass("current-player"):$("#player"+a).removeClass("current-player"),$("#dice"+a).html(b.numContiguous(a)),$("#stored"+a).html(b.storedDice(a)))}}}),$(function(){$("#radio_2d").change(function(){$("#radio_2d").prop("checked")&&Renderer._init2d.apply(Renderer)}),$("#radio_3d").change(function(){$("#radio_3d").prop("checked")&&Renderer._init3d.apply(Renderer)}),window.Renderer={iface:{mouseOverCountry:function(a){},stateRendered:function(a,b){}},_renderer:null,_history:[],_rendering:!1,_lastState:null,_renderCallback:null,_listener:null,_canvas:null,_map:null,_playerNames:[],_initialized2d:!1,_initialized3d:!1,init:function(a,b,c,d){Globals.ASSERT(Globals["implements"](d,Renderer.iface)),this._renderCallback=d.stateRendered,d.stateRendered=this._stateRendered.bind(this),this._listener=d,this._canvas=a,this._map=b,this._playerNames=c,$("#radio_3d").attr("checked")?Renderer._init3d():Renderer._init2d(),PlayerStatus.init(c)},setPlayerName:function(a,b){PlayerStatus.setPlayerName(a,b)},stateUpdate:function(a,b){this._lastState=a,this._history.push(a),this._renderNext()},renderHistory:function(a){this._renderer.render(a,this._renderCallback)},setMouseOverCountry:function(a){this._renderer.setMouseOverCountry(a)},setSelectedCountry:function(a){this._renderer.setSelectedCountry(a)},_init2d:function(){$("#radio_2d").prop("checked",!0),$("#canvas3d_div").hide(),$("#c").show(),this._renderer=Renderer2d,this._initialized2d||(this._initialized2d=!0,this._renderer.init(this._canvas,this._map,this._playerNames,this._listener)),this._lastState&&this.stateUpdate(this._lastState,this._lastState.stateId())},_init3d:function(a,b,c,d,e){$("#radio_3d").prop("checked",!0),$("#c").hide(),$("#canvas3d_div").show(),this._renderer=GLrenderer,this._initialized3d||(this._initialized3d=!0,this._renderer.init(this._canvas,this._map,this._playerNames,this._listener)),this._lastState&&this.stateUpdate(this._lastState,this._lastState.stateId())},_render:function(a,b){this._renderer.render(a,b)},_stateRendered:function(a,b){this._rendering=!1,this._renderCallback(a,b),this._renderNext()},_renderNext:function(){if(!this._rendering&&this._history.length){var a=this._history.shift();this._rendering=!0,this._render(a,this._stateRendered.bind(this)),PlayerStatus.renderPlayers(a)}}}});var Renderer2d={_canvas:null,_context:null,_initialized:!1,_isRendering:!1,_highlightedCountry:-1,_selectedCountry:-1,_mouseOverCountry:-1,_names:[],_map:null,_playerColors:["red","blue","green","yellow","orange","purple","brown","tan"],_lastRenderedState:null,_listener:null,init:function(a,b,c,d){if(!Globals.suppress_ui){if(Globals.ASSERT(Globals["implements"](d,Renderer.iface)),this._canvas=a,!a)return;this._context=this._canvas.getContext("2d"),this.clearAll(),this._context.lineJoin="straight",this._map=b,this._names=c||[],this._listener=d,$(a).mousemove(this.mouseMove.bind(this)),$(a).mouseleave(this.mouseLeave.bind(this)),this._initialized=!0}},clearAll:function(){!Globals.suppress_ui&&this._initialized&&(Globals.debug("clearAll",Globals.LEVEL.INFO,Globals.CHANNEL.RENDERER),this._context.clearRect(0,0,2e3,2e3),this.stateHash.reset())},mouseMove:function(a){if(this._listener){var b=this._map.fromMousePos(a.offsetX,a.offsetY),c=b?b.countryId():-1;c!=this._mouseOverCountry&&(this._mouseOverCountry=c,this._listener.mouseOverCountry(c))}},mouseLeave:function(a){this._listener&&-1!=this._mouseOverCountry&&(this._mouseOverCountry=-1,this._listener.mouseOverCountry(-1))},setMouseOverCountry:function(a){this._isRendering||(Renderer2d._highlightedCountry=a,this.render(this._lastRenderedState,null))},setSelectedCountry:function(a){this._isRendering||(Renderer2d._selectedCountry=a,this.render(this._lastRenderedState,null))},render:function(a,b){var c=this;return c._isRendering?(Globals.debug("previous state rendering, render aborted",Globals.LEVEL.DEBUG,Globals.CHANNEL.RENDERER),void b()):(Globals.debug("render()",Globals.LEVEL.INFO,Globals.CHANNEL.RENDERER),Globals.ASSERT(a instanceof Gamestate),c._renderMap(a),c._lastRenderedState=a,void(a.attack()?c._renderAttack(a,b):b&&b(a,a.stateId())))},_renderAttack:function(a,b){function c(a){$("#lefttotal").html(i),$("#leftroll").show(),f._renderCountry(h,a,!0),window.setTimeout(function(){d(a)},k)}function d(a){Globals.debug("render defender",Globals.LEVEL.DEBUG,Globals.CHANNEL.RENDERER),$("#righttotal").html(j),$("#rightroll").show(),window.setTimeout(function(){e(a)},k)}function e(a){Globals.debug("render verdict",Globals.LEVEL.DEBUG,Globals.CHANNEL.RENDERER),i>j?Globals.play_sounds&&b&&$.playSound("/sounds/clink_sound"):Globals.play_sounds&&b&&$.playSound("/sounds/wood_hit_brick_1"),f._isRendering=!1,b&&b(a,a.stateId())}if(Globals.suppress_ui||!this._initialized||!a)return void b();Globals.debug("renderAttack",Globals.LEVEL.INFO,Globals.CHANNEL.RENDERER);var f=this,g=a.attack().fromCountryId,h=(a.countryOwner(g),a.attack().toCountryId),i=(a.attack().fromRollArray.length,a.attack().toRollArray.length,a.attack().fromRollArray.reduce(function(a,b){return a+b},0)),j=a.attack().toRollArray.reduce(function(a,b){return a+b},0);f._resetRollDivs(a,g,h,a.attack().fromRollArray,a.attack().toRollArray),Globals.debug("render attacker",Globals.LEVEL.DEBUG,Globals.CHANNEL.RENDERER),f._renderCountry(g,a,!0),Globals.play_sounds&&b&&$.playSound("/sounds/2_dice_throw_on_table"),f._isRendering=!0;var k=b?Globals.timeout:0;window.setTimeout(function(){c(a)},k)},_renderMap:function(a){if(!Globals.suppress_ui&&this._initialized){Globals.debug("renderMap",Globals.LEVEL.INFO,Globals.CHANNEL.RENDERER),Globals.ASSERT(a instanceof Gamestate);var b=this;a.countryIds().forEach(function(c){b._renderCountry(c,a)})}},_renderCountry:function(a,b,c){if(!Globals.suppress_ui&&this._initialized&&this.stateHash.hasCountryChanged(a,c,b.countryHash(a))){Globals.debug("renderCountry "+a,Globals.LEVEL.DEBUG,Globals.CHANNEL.RENDERER);var d=this;c=c||!1,d._map.countryHexes(a).forEach(function(a){d._renderHex(d._map.getHex(a),b,c)});var e=d._map.countryCenter(a);if(d._renderNumberBox(a,b),Globals.markCountryCenters){var f=new Path2D;f.moveTo(e[0]-4,e[1]-4),f.lineTo(e[0]+4,e[1]+4),f.closePath(),d._context.strokeStyle="black",d._context.lineWidth=2,d._context.stroke(f),f=new Path2D,f.moveTo(e[0]-4,e[1]+4),f.lineTo(e[0]+4,e[1]-4),f.closePath(),d._context.strokeStyle="black",d._context.lineWidth=2,d._context.stroke(f)}Globals.drawCountryConnections&&d._map.adjacentCountries(a).forEach(function(a){var b=d._map.countryCenter(a.id()),c=new Path2D;c.moveTo(e[0],e[1]),c.lineTo(b[0],b[1]),c.closePath(),d._context.strokeStyle="black",d._context.lineWidth=1,d._context.stroke(c)}),d._map.adjacentCountries(a).forEach(function(a){d._renderNumberBox(a,b)})}},_resetRollDivs:function(a,b,c,d,e){if(!Globals.suppress_ui&&this._initialized){var f=this;if($("#leftroll").hide(),$("#rightroll").hide(),b&&c&&d&&e)for(var g=d.length,h=e.length,i=(d.reduce(function(a,b){return a+b}),e.reduce(function(a,b){return a+b}),0);i<Globals.maxDice;i++)$("#leftdie"+i).css({"background-color":f._playerColors[a.countryOwner(b)]}),g>i?($("#leftdie"+i).html(d[i]),$("#leftdie"+i).show()):$("#leftdie"+i).hide(),$("#rightdie"+i).css({"background-color":f._playerColors[a.countryOwner(c)]}),h>i?($("#rightdie"+i).html(e[i]),$("#rightdie"+i).show()):$("#rightdie"+i).hide()}},_renderNumberBox:function(a,b){if(!Globals.suppress_ui&&this._initialized){var c=this,d=c._map.countryCenter(a),e=10;Globals.showCountryIds&&(e=12),c._context.fillStyle="white",c._context.fillRect(d[0]-e,d[1]-1.6*e,2*e,2*e),c._context.rect(d[0]-e,d[1]-1.6*e,2*e,2*e),Globals.showCountryIds||(c._context.lineWidth=1,c._context.strokeStyle="black",c._context.stroke()),c._context.fillStyle="black",c._context.font="bold 18px sans-serif",Globals.showCountryIds?c._context.textAlign="right":c._context.textAlign="center",c._context.fillText(b.countryDice(a),d[0],d[1]),Globals.showCountryIds&&(c._context.fillStyle="black",c._context.textAlign="left",c._context.font="10px sans-serif",c._context.fillText(a,d[0],d[1]))}},_renderHex:function(a,b,c){if(!Globals.suppress_ui&&this._initialized){var d=this,e=a.countryId(),f=a.upperLeft(),g=f[0],h=f[1],i=new Path2D;if(i.moveTo(g-Hex.FUDGE,h-Hex.FUDGE),i.lineTo(g+Hex.EDGE_LENGTH+Hex.FUDGE,h-Hex.FUDGE),i.lineTo(g+Hex.EDGE_LENGTH+Hex.EDGE_LENGTH/2,h+Hex.HEIGHT/2),i.lineTo(g+Hex.EDGE_LENGTH+Hex.FUDGE,h+Hex.HEIGHT+Hex.FUDGE),i.lineTo(g-Hex.FUDGE,h+Hex.HEIGHT+Hex.FUDGE),i.lineTo(g-Hex.EDGE_LENGTH/2,h+Hex.HEIGHT/2),i.lineTo(g-Hex.FUDGE,h-Hex.FUDGE),i.closePath(),d._context.fillStyle=Renderer2d._countryDrawColor(e,b,c),a._color&&(d._context.fillStyle=a._color),d._context.fill(i),a._countryEdgeDirections.forEach(function(b){var e=new Path2D;switch(b){case Dir.obj.NW:case"NW":e.moveTo(g,h),e.lineTo(g-Hex.EDGE_LENGTH/2,h+Hex.HEIGHT/2);break;case Dir.obj.N:case"N":e.moveTo(g,h),e.lineTo(g+Hex.EDGE_LENGTH,h);break;case Dir.obj.NE:case"NE":e.moveTo(g+Hex.EDGE_LENGTH,h),e.lineTo(g+Hex.EDGE_LENGTH+Hex.EDGE_LENGTH/2,h+Hex.HEIGHT/2);break;case Dir.obj.SE:case"SE":e.moveTo(g+Hex.EDGE_LENGTH+Hex.EDGE_LENGTH/2,h+Hex.HEIGHT/2),e.lineTo(g+Hex.EDGE_LENGTH,h+Hex.HEIGHT);break;case Dir.obj.S:case"S":e.moveTo(g+Hex.EDGE_LENGTH,h+Hex.HEIGHT),e.lineTo(g,h+Hex.HEIGHT);break;case Dir.obj.SW:case"SW":e.moveTo(g,h+Hex.HEIGHT),e.lineTo(g-Hex.EDGE_LENGTH/2,h+Hex.HEIGHT/2)}e.closePath(),d._context.strokeStyle=c?"red":"black",d._context.lineWidth=a.BORDER_THICKNESS,d._context.stroke(e)}),Globals.showNumbers&&(d._context.lineWidth=1,d._context.font="11px sans-serif",d._context.strokeText(a._id,g,h+a.HEIGHT/2)),Globals.markHexCenters){var j=a.center(),i=new Path2D;i.moveTo(j[0]-2,j[1]-2),i.lineTo(j[0]+2,j[1]+2),i.closePath(),d._context.strokeStyle="black",d._context.lineWidth=1,d._context.stroke(i),i=new Path2D,i.moveTo(j[0]-2,j[1]+2),i.lineTo(j[0]+2,j[1]-2),i.closePath(),d._context.strokeStyle="black",d._context.lineWidth=1,d._context.stroke(i)}}},_countryDrawColor:function(a,b,c){var d=this,e=b.countryOwner(a);return c?"black":a==d._highlightedCountry?a==d._selectedCountry?"gray":"lightgray":a==d._selectedCountry?"black":d._playerColors[e]},_setupRollDivs:function(){$("#leftroll").hide(),$("#rightroll").hide();for(var a=[],b=0;b<Globals.maxDice;b++)$("#leftroll").append("<div id='leftdie"+b+"' class='roll-die'>5</div>"),a.push("#leftdie"+b),$("#rightroll").append("<div id='rightdie"+b+"' class='roll-die'>5</div>"),a.push("#rightdie"+b);$("#leftroll").append("<div id='lefttotal' class='roll-total'>35</div>"),$("#rightroll").append("<div id='righttotal' class='roll-total'>35</div>")},stateHash:{_players:{},_countries:{},reset:function(){this._players={},this._countries={}},hasPlayerChanged:function(a,b){return this._players[a]===b?!1:(this._players[a]=b,!0)},hasCountryChanged:function(a,b,c){return b&&(c+=1),a==Renderer2d._highlightedCountry&&(c+=2),a==Renderer2d._selectedCountry&&(c+=4),this._countries[a]===c?!1:(this._countries[a]=c,!0)}}},MAX_RETRIES=5,Downloader=function(){this._array=[],this._retryCount=0,this._pending=!1,this._timeout=10};Downloader.prototype.hasPending=function(){return this._pending},Downloader.prototype.get=function(a,b){Globals.debug("Push url",a,Globals.LEVEL.DEBUG,Globals.CHANNEL.DOWNLOADER),this._array.push({url:a,cb:b}),this._doNext()},Downloader.prototype.getGameInfo=function(a,b){var c="/getGameInfo?gameId="+a;this.get(c,b)},Downloader.prototype.getMap=function(a,b){var c="/getMap?gameId="+a;this.get(c,b)},Downloader.prototype.getState=function(a,b,c){var d="/getState?gameId="+a+"&moveId="+b;this.get(d,c)},Downloader.prototype.getStateCount=function(a,b){var c="/getStateCount?gameId="+a;this.get(c,b)},Downloader.prototype.getAIs=function(a){var b="/aisjson";this.get(b,a)},Downloader.prototype._doNext=function(){var a=this;!a._pending&&a._array.length&&(a._pending=!0,window.setTimeout(function(){var b=a._array[0].url;Globals.debug("Download url",b,Globals.LEVEL.INFO,Globals.CHANNEL.DOWNLOADER),$.get(b).done(function(b){a.ajaxDone(b)}).fail(function(b){a.ajaxFail(b)})},a._timeout))},Downloader.prototype.ajaxDone=function(a){Globals.ASSERT(this._pending);var b=this;b._timeout=10,b._retryCount=0;var c=b._array.shift();Globals.debug("Got url",c.url,Globals.LEVEL.INFO,Globals.CHANNEL.DOWNLOADER),b._pending=!1,c&&c.cb&&c.cb(!0,a),b._doNext()},Downloader.prototype.ajaxFail=function(a){Globals.debug("DOWNLOAD FAILURE: ",a.error(),JSON.stringify(a),Globals.LEVEL.WARN,Globals.CHANNEL.DOWNLOADER);var b=this;if(b._retryCount++,b._retryCount>MAX_RETRIES){b._retryCount=0,b._timeout=10;var c=b._array.shift();c&&c.cb&&c.cb(!1,a)}else b._timeout<1e4&&(b._timeout=5*b._timeout),b._pending=!1,b._doNext()};var History=function(a){this._states={},this._gameId=a,this._downloader=new Downloader,this._mostRecentStateId=-1,this._stateCallbacks={}};History.prototype.getState=function(a,b){Globals.ASSERT("number"==typeof a);var c=this;return c._states[a]?(b&&b(c._states[a]),c._states[a]):(b&&c.onStateReceived(a,b),c._downloader.getState(c._gameId,a,c._stateDownload.bind(c)),null)},History.prototype.latestId=function(){return this._mostRecentStateId},History.prototype.getLatest=function(){var a=this;return a._states[a._mostRecentStateId]},History.prototype._stateDownload=function(a,b){var c=this;if(a){var d=Gamestate.deserialize(JSON.parse(b.data)),e=parseInt(b.id);if(Globals.debug("Downloaded state",e,Globals.LEVEL.DEBUG,Globals.CHANNEL.CLIENT),e>c._mostRecentStateId&&(c._mostRecentStateId=e),c._states.hasOwnProperty(e))Globals.debug("Downloaded state we already have",e,Globals.LEVEL.WARN,Globals.CHANNEL.CLIENT);else if(c._states[e]=d,c._stateCallbacks.hasOwnProperty(e)){var f=c._stateCallbacks[e];delete c._stateCallbacks[e],f.forEach(function(a){a(d)})}}else Globals.debug("Error downloading state data",b,Globals.LEVEL.ERROR,Globals.CHANNEL.CLIENT)},History.prototype.onStateReceived=function(a,b){var c=this;c._states.hasOwnProperty(a)?b(c._states[a]):(c._stateCallbacks.hasOwnProperty(a)||(c._stateCallbacks[a]=[]),c._stateCallbacks[a].push(b))};var MapRequest=function(a,b,c){this.id=a,this.data=b,this.cb=c,this.dataCount=b.length,this.resultsCount=0,this.results=[],this.results.length=b.length},Mapper=function(a){this._threads=a||4,this._workers=[],this._reqs={},this._nextReqId=0;for(var b=0;b<this._threads;b++)this._workers.push(new Worker("/js/util/worker.js")),this._workers[b].onmessage=this._callback.bind(this)};Mapper.prototype.map=function(a,b,c){var d=this,e=new MapRequest(d._nextReqId++,a,c);d._reqs[e.id]=e;var f=b.toString(),g=f.indexOf("(")+1,h=f.indexOf(")"),i=f.substr(g,h-g).split(",");i=i.map(function(a){return a.trim()}),f=f.substr(f.indexOf("{"));for(var j=100,k=0,l=[],m=0;m<a.length;m++)l.push({command:"compute",data:a[m],fn:f,args:i,data_id:m,id:e.id}),(l.length>=j||m==a.length-1)&&(d._workers[k]&&(d._workers[k].postMessage({command:"batch",data:l,id:e.id}),l=[]),k++,k%=d._workers.length)},Mapper.prototype.stop=function(){this._workers.forEach(function(a){a.onmessage=null}),this._workers.length=0},Mapper.prototype._callback=function(a){var b=this,c=a.data,d=b._reqs[c.id];d&&("result"==c.command?b.receiveResult(d,c):"batch_result"==c.command?c.result.forEach(function(a){b.receiveResult(d,a)}):"error"==c.command&&d.cb(c.msg))},Mapper.prototype.receiveResult=function(a,b){var c=this;a.results[b.data_id]=b.result,a.resultsCount++,a.resultsCount==a.dataCount&&(delete c._reqs[a.id],a.cb&&a.cb(a.results))};var Uploader=function(){this._array=[],this._pending=!1,this._timeout=10,this._retryCount=0};Uploader.MAX_RETRIES=4,Uploader.prototype.push=function(a,b){this._array.push({url:a,data:b}),this._doNext()},Uploader.prototype.uploadMap=function(a,b){var c="/uploadMap?gameId="+a;this.push(c,b)},Uploader.prototype.uploadState=function(a,b,c){var d="/uploadState?gameId="+a+"&moveId="+b;this.push(d,c)},Uploader.prototype.uploadGameInfo=function(a,b,c){var d="/uploadGameInfo?gameId="+a;c&&(d+="&ratingCode="+c),this.push(d,b)},Uploader.prototype.uploadLogDump=function(a,b){var c="/uploadErrorReport?gameId="+a;this.push(c,JSON.stringify(b))},Uploader.prototype._doNext=function(){var a=this;!a._pending&&a._array.length&&(a._pending=!0,window.setTimeout(function(){var b=a._array[0];$.ajax({url:b.url,type:"POST",dataType:"json",contentType:"application/json; charset=utf-8",data:b.data,success:a.ajaxDone.bind(a),failure:a.ajaxFail.bind(a)})},a._timeout))},Uploader.prototype.ajaxDone=function(a){Globals.ASSERT(this._pending);var b=this;b._timeout=10,b._retryCount=0,b._array.shift(),b._pending=!1,b._doNext()},Uploader.prototype.ajaxFail=function(a){console.log("UPLOAD FAILURE: ",a.error(),JSON.stringify(a));var b=this;b._retryCount>=Uploader.MAX_RETRIES?b.ajaxDone():(b._retryCount++,b._timeout<1e4&&(b._timeout=10*b._timeout),b._pending=!1,b._doNext())},onmessage=function(a){var b=a.data;try{if("compute"==b.command)postMessage(compute(b));else if("batch"==b.command){var c=[];b.data.forEach(function(a){c.push(compute(a))}),postMessage({command:"batch_result",result:c,id:b.id})}}catch(d){console.log(d),postMessage({command:"error",msg:JSON.stringify(d),data_id:b.data_id,id:b.id})}};var compute=function(a){Array.isArray(a.data)||(a.data=[a.data]);var b=new Function(a.args,a.fn),c=b.apply(null,a.data);return{command:"result",result:c,data_id:a.data_id,id:a.id}};